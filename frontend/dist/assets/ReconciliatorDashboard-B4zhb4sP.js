import{b as I,r as n,l as B,j as e,f as F,U as K,X as q}from"./index-f8gYbhCl.js";import{_ as z}from"./style-QQ25Eq_G.js";import{u as H}from"./index.esm-CD2Rk9NM.js";import{a as V,o as J,s as b,_ as W,p as X,n as G}from"./schemas-B-PNgsin.js";import{a as j}from"./api-BYptnXG6.js";import{t as l}from"./index-Cne2OvF7.js";import{H as _}from"./handshake-9h3u9doN.js";import{C as Q}from"./calendar-l8FpB4bB.js";import{A as Y}from"./arrow-up-right-C7V6SZxH.js";import{D as Z}from"./download-prd_qkFN.js";import"./index-Dgkh_OCz.js";const ee="/socket.io",se="http://localhost:5000",te=J({title:b().min(3,"Title is required"),participants:b().min(3,"Provide at least one participant identifier"),scheduledAt:b().min(1,"Date & time required"),durationMinutes:X(o=>Number(o),G().min(5,"Duration at least 5 minutes")),mode:W(["virtual","in-person"]),linkOrLocation:b().optional().nullable(),notes:b().optional().nullable()});function he(){const{user:o}=I()||{},[c,m]=n.useState([]),[N,L]=n.useState([]),[y,S]=n.useState(!0),[ae,R]=n.useState(null),[M,h]=n.useState(!1),[g,p]=n.useState(null),{register:d,handleSubmit:D,reset:f,setValue:x,formState:{errors:r,isSubmitting:C}}=H({resolver:V(te),defaultValues:{title:"",participants:"",scheduledAt:"",durationMinutes:30,mode:"virtual",linkOrLocation:"",notes:""}}),v=n.useCallback(async()=>{S(!0);try{const[s,t]=await Promise.all([j.get("/reconciliations"),j.get("/participants").catch(()=>j.get("/clients").catch(()=>({data:[]})))]);m(Array.isArray(s.data)?s.data:[]),L(Array.isArray(t.data)?t.data:[])}catch(s){console.error("Failed to load reconciliator dashboard:",s),l.error(s?.response?.data?.message||"Failed to load data")}finally{S(!1)}},[]);n.useEffect(()=>{v()},[v]),n.useEffect(()=>{if(!o||!o._id)return;const s=B(se,{path:ee,transports:["websocket"],withCredentials:!0,auth:{token:localStorage.getItem("token")},query:{userId:o._id,role:o.role}});return R(s),s.on("connect",()=>{console.info("Reconciliator socket connected:",s.id),s.emit("join",{room:`reconciliator:${o._id}`})}),s.on("recon:created",t=>{t&&(m(i=>[t,...i]),l.success(`Reconciliation scheduled: ${t.title}`))}),s.on("recon:updated",t=>{t&&(m(i=>i.map(a=>a._id===t._id?t:a)),l.success(`Reconciliation updated: ${t.title}`))}),s.on("recon:closed",({id:t,result:i})=>{m(a=>a.map(u=>u._id===t?{...u,status:"closed",result:i}:u)),l.success("Reconciliation closed")}),s.on("notifications:new",t=>{l.info(t?.message||"New notification")}),s.on("disconnect",t=>{console.warn("Socket disconnected:",t)}),s.on("connect_error",t=>{console.error("Socket connection error:",t),l.error("Real-time connection failed")}),()=>{s.removeAllListeners(),s.disconnect(),R(null)}},[o]);const O=async s=>{try{const t={...s,durationMinutes:Number(s.durationMinutes)};if(g){const{data:i}=await j.put(`/reconciliations/${g._id}`,t);m(a=>a.map(u=>u._id===i._id?i:u)),l.success("Reconciliation updated")}else{const{data:i}=await j.post("/reconciliations",t);m(a=>[i,...a]),l.success("Reconciliation scheduled")}f(),p(null),h(!1)}catch(t){throw console.error("Submit reconciliation failed:",t),l.error(t?.response?.data?.message||"Failed to save reconciliation"),t}},U=s=>{p(s),h(!0),x("title",s.title||""),x("participants",(s.participants||[]).join(", ")),x("scheduledAt",s.scheduledAt?new Date(s.scheduledAt).toISOString().slice(0,16):""),x("durationMinutes",s.durationMinutes||30),x("mode",s.mode||"virtual"),x("linkOrLocation",s.linkOrLocation||""),x("notes",s.notes||"")},E=async s=>{try{const t=await j.get(`/reconciliations/${s}/report`,{responseType:"blob"}),i=window.URL.createObjectURL(new Blob([t.data])),a=document.createElement("a");a.href=i,a.setAttribute("download",`reconciliation-${s}-report.pdf`),document.body.appendChild(a),a.click(),a.remove(),l.success("Report downloaded")}catch(t){console.error("Download report failed:",t),l.error("Failed to download report")}},P=s=>{if(s.mode==="virtual"){const t=s.linkOrLocation||s.virtualRoomUrl;if(!t){l.error("No virtual link provided");return}window.open(t,"_blank")}else s.linkOrLocation?window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(s.linkOrLocation)}`,"_blank"):l.error("No physical location provided")},w=n.useMemo(()=>{const s=c.length,t=c.filter(a=>(a.status||"").toLowerCase()==="open"||!a.status).length,i=c.filter(a=>(a.status||"").toLowerCase()==="closed").length;return{total:s,open:t,closed:i}},[c]),A=n.useMemo(()=>{const s={};for(const i of c){const a=i.scheduledAt?new Date(i.scheduledAt).toLocaleDateString():"Unscheduled";s[a]=s[a]||[],s[a].push(i)}const t=Object.keys(s).sort((i,a)=>i==="Unscheduled"?1:a==="Unscheduled"?-1:new Date(i)-new Date(a));return{groups:s,orderedKeys:t}},[c]);return e.jsxs("div",{className:"jsx-2159153259 reconciliator-dashboard min-h-screen p-6 bg-black-50",children:[e.jsxs("div",{className:"jsx-2159153259 flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6",children:[e.jsxs("div",{className:"jsx-2159153259",children:[e.jsxs("h1",{className:"jsx-2159153259 text-3xl font-extrabold text-slate-900",children:[e.jsx(_,{})," Reconciliator Dashboard"]}),e.jsx("p",{className:"jsx-2159153259 text-slate-600 mt-1",children:"Schedule reconciliation meetings, track progress and record outcomes — realtime."})]}),e.jsxs("div",{className:"jsx-2159153259 flex gap-3",children:[e.jsxs("button",{onClick:()=>{p(null),f(),h(!0)},className:"jsx-2159153259 inline-flex items-center gap-2 px-4 py-2 rounded-md bg-blue-600 text-white",children:[e.jsx(Q,{size:16})," New Meeting"]}),e.jsx("button",{onClick:v,className:"jsx-2159153259 inline-flex items-center gap-2 px-4 py-2 rounded-md bg-white border",children:"Refresh"})]})]}),e.jsxs("div",{className:"jsx-2159153259 grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6",children:[e.jsx(k,{icon:e.jsx(_,{}),label:"Total Meetings",value:w.total,className:"jsx-2159153259"}),e.jsx(k,{icon:e.jsx(F,{}),label:"Open",value:w.open,className:"jsx-2159153259"}),e.jsx(k,{icon:e.jsx($,{className:"jsx-2159153259"}),label:"Closed",value:w.closed,className:"jsx-2159153259"})]}),e.jsxs("div",{className:"jsx-2159153259 grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("section",{className:"jsx-2159153259 lg:col-span-2 space-y-4",children:[e.jsxs("div",{className:"jsx-2159153259 bg-white p-4 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"jsx-2159153259 flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"jsx-2159153259 text-lg font-semibold",children:"Upcoming & Recent Meetings"}),e.jsxs("div",{className:"jsx-2159153259 text-sm text-slate-500",children:[c.length," total"]})]}),y?e.jsxs("div",{className:"jsx-2159153259 space-y-2 animate-pulse",children:[e.jsx("div",{className:"jsx-2159153259 h-8 bg-black-200 rounded"}),e.jsx("div",{className:"jsx-2159153259 h-8 bg-black-200 rounded"})]}):c.length===0?e.jsx("div",{className:"jsx-2159153259 text-slate-500",children:"No meetings scheduled."}):A.orderedKeys.map(s=>e.jsxs("div",{className:"jsx-2159153259 mb-4",children:[e.jsx("div",{className:"jsx-2159153259 text-sm font-medium text-slate-700 mb-2",children:s}),e.jsx("div",{className:"jsx-2159153259 space-y-2",children:A.groups[s].sort((t,i)=>new Date(t.scheduledAt||0)-new Date(i.scheduledAt||0)).map(t=>e.jsxs("div",{className:"jsx-2159153259 p-3 rounded-md bg-slate-50 flex items-start justify-between",children:[e.jsxs("div",{className:"jsx-2159153259",children:[e.jsx("div",{className:"jsx-2159153259 font-semibold",children:t.title}),e.jsx("div",{className:"jsx-2159153259 text-xs text-slate-500 mt-1",children:(t.participants||[]).join(", ")}),e.jsx("div",{className:"jsx-2159153259 text-xs text-slate-400 mt-1",children:t.scheduledAt?new Date(t.scheduledAt).toLocaleString():"Unscheduled"})]}),e.jsxs("div",{className:"jsx-2159153259 flex flex-col items-end gap-2",children:[e.jsxs("div",{className:"jsx-2159153259 flex gap-2",children:[e.jsxs("button",{onClick:()=>P(t),className:"jsx-2159153259 px-3 py-1 rounded bg-blue-600 text-white text-xs flex items-center gap-1",children:[e.jsx(Y,{size:12})," Join"]}),e.jsx("button",{onClick:()=>U(t),className:"jsx-2159153259 px-3 py-1 rounded bg-white border text-xs",children:"Edit"}),e.jsxs("button",{onClick:()=>E(t._id),className:"jsx-2159153259 px-3 py-1 rounded bg-white border text-xs flex items-center gap-1",children:[e.jsx(Z,{size:12})," Report"]})]}),e.jsx("div",{className:"jsx-2159153259 text-xs text-slate-500",children:e.jsx("span",{className:`jsx-2159153259 px-2 py-1 rounded ${T(t.status)}`,children:t.status||"open"})})]})]},t._id))})]},s))]}),e.jsxs("div",{className:"jsx-2159153259 bg-white p-4 rounded-lg shadow-sm",children:[e.jsx("h3",{className:"jsx-2159153259 font-semibold mb-2",children:"Progress & Outcomes"}),e.jsx("p",{className:"jsx-2159153259 text-sm text-slate-600",children:"Record outcomes when a meeting completes — these are tracked and can be exported as reports."}),e.jsx("div",{className:"jsx-2159153259 mt-3 text-sm",children:e.jsx("p",{className:"jsx-2159153259",children:'To close a meeting, click Edit → change status to "closed" and add the outcome in notes.'})})]})]}),e.jsxs("aside",{className:"jsx-2159153259 space-y-4",children:[e.jsxs("div",{className:"jsx-2159153259 bg-white p-4 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"jsx-2159153259 flex items-center justify-between mb-3",children:[e.jsxs("h3",{className:"jsx-2159153259 font-semibold flex items-center gap-2",children:[e.jsx(K,{})," Participants"]}),e.jsx("div",{className:"jsx-2159153259 text-sm text-slate-500",children:N.length})]}),y?e.jsxs("div",{className:"jsx-2159153259 space-y-2 animate-pulse",children:[e.jsx("div",{className:"jsx-2159153259 h-8 bg-black-200 rounded"}),e.jsx("div",{className:"jsx-2159153259 h-8 bg-black-200 rounded"})]}):N.length===0?e.jsx("div",{className:"jsx-2159153259 text-slate-500",children:"No participants found"}):e.jsx("ul",{className:"jsx-2159153259 max-h-64 overflow-auto space-y-2 text-sm",children:N.map(s=>e.jsxs("li",{className:"jsx-2159153259 flex items-center justify-between p-2 rounded hover:bg-slate-50",children:[e.jsxs("div",{className:"jsx-2159153259",children:[e.jsx("div",{className:"jsx-2159153259 font-medium",children:s.name||s.fullName||s.email}),e.jsx("div",{className:"jsx-2159153259 text-xs text-slate-500",children:s.email||s.phone})]}),e.jsx("button",{onClick:()=>window.open(`/messages/compose?to=${encodeURIComponent(s._id||s.email)}`,"_blank"),className:"jsx-2159153259 text-slate-600",children:"Message"})]},s._id||s.email))})]}),e.jsxs("div",{className:"jsx-2159153259 bg-white p-4 rounded-lg shadow-sm",children:[e.jsx("h3",{className:"jsx-2159153259 font-semibold mb-2",children:"Notifications"}),e.jsx("p",{className:"jsx-2159153259 text-sm text-slate-500",children:"Live notifications arrive automatically. For persistence, implement /notifications endpoint and fetch here."})]})]})]}),M&&e.jsx("div",{className:"jsx-2159153259 fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4",children:e.jsxs("div",{className:"jsx-2159153259 bg-white rounded-lg shadow-lg w-full max-w-2xl p-6",children:[e.jsxs("div",{className:"jsx-2159153259 flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"jsx-2159153259 text-lg font-semibold",children:g?"Edit Meeting":"Schedule Meeting"}),e.jsx("button",{onClick:()=>{h(!1),p(null),f()},className:"jsx-2159153259 p-2 rounded hover:bg-slate-100",children:e.jsx(q,{})})]}),e.jsxs("form",{onSubmit:D(O),className:"jsx-2159153259 space-y-4",children:[e.jsxs("div",{className:"jsx-2159153259",children:[e.jsx("label",{className:"jsx-2159153259 block text-sm font-medium",children:"Title"}),e.jsx("input",{...d("title"),className:"jsx-2159153259 mt-1 w-full rounded-md border p-2"}),r.title&&e.jsx("p",{className:"jsx-2159153259 text-xs text-red-600",children:r.title.message})]}),e.jsxs("div",{className:"jsx-2159153259",children:[e.jsx("label",{className:"jsx-2159153259 block text-sm font-medium",children:"Participants (comma-separated identifiers)"}),e.jsx("input",{...d("participants"),placeholder:"Party A, Party B",className:"jsx-2159153259 mt-1 w-full rounded-md border p-2"}),r.participants&&e.jsx("p",{className:"jsx-2159153259 text-xs text-red-600",children:r.participants.message})]}),e.jsxs("div",{className:"jsx-2159153259 grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{className:"jsx-2159153259",children:[e.jsx("label",{className:"jsx-2159153259 block text-sm font-medium",children:"Date & Time"}),e.jsx("input",{...d("scheduledAt"),type:"datetime-local",className:"jsx-2159153259 mt-1 w-full rounded-md border p-2"}),r.scheduledAt&&e.jsx("p",{className:"jsx-2159153259 text-xs text-red-600",children:r.scheduledAt.message})]}),e.jsxs("div",{className:"jsx-2159153259",children:[e.jsx("label",{className:"jsx-2159153259 block text-sm font-medium",children:"Duration (minutes)"}),e.jsx("input",{...d("durationMinutes",{valueAsNumber:!0}),type:"number",min:5,className:"jsx-2159153259 mt-1 w-full rounded-md border p-2"}),r.durationMinutes&&e.jsx("p",{className:"jsx-2159153259 text-xs text-red-600",children:r.durationMinutes.message})]})]}),e.jsxs("div",{className:"jsx-2159153259 grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{className:"jsx-2159153259",children:[e.jsx("label",{className:"jsx-2159153259 block text-sm font-medium",children:"Mode"}),e.jsxs("select",{...d("mode"),className:"jsx-2159153259 mt-1 w-full rounded-md border p-2",children:[e.jsx("option",{value:"virtual",className:"jsx-2159153259",children:"Virtual"}),e.jsx("option",{value:"in-person",className:"jsx-2159153259",children:"In-person"})]})]}),e.jsxs("div",{className:"jsx-2159153259",children:[e.jsx("label",{className:"jsx-2159153259 block text-sm font-medium",children:"Link or Location (optional)"}),e.jsx("input",{...d("linkOrLocation"),className:"jsx-2159153259 mt-1 w-full rounded-md border p-2"})]})]}),e.jsxs("div",{className:"jsx-2159153259",children:[e.jsx("label",{className:"jsx-2159153259 block text-sm font-medium",children:"Notes"}),e.jsx("textarea",{...d("notes"),rows:4,className:"jsx-2159153259 mt-1 w-full rounded-md border p-2"})]}),e.jsxs("div",{className:"jsx-2159153259 flex justify-end gap-3",children:[e.jsx("button",{type:"button",onClick:()=>{h(!1),p(null),f()},className:"jsx-2159153259 px-4 py-2 rounded bg-black-100",children:"Cancel"}),e.jsx("button",{type:"submit",disabled:C,className:"jsx-2159153259 px-4 py-2 rounded bg-blue-600 text-white",children:C?"Saving...":g?"Save changes":"Schedule"})]})]})]})}),e.jsx(z,{id:"2159153259",children:['.reconciliator-dashboard.jsx-2159153259{font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}']})]});function k({icon:s,label:t,value:i}){return e.jsxs("div",{className:"bg-white p-4 rounded-lg shadow-sm flex items-center gap-4",children:[e.jsx("div",{className:"p-2 bg-blue-50 rounded-md text-blue-600",children:s}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-slate-500",children:t}),e.jsx("div",{className:"text-2xl font-bold text-slate-900",children:i})]})]})}function T(s=""){const t=(s||"").toString().toLowerCase();return t.includes("closed")?"bg-green-100 text-green-800":t.includes("open")?"bg-amber-100 text-amber-800":t.includes("scheduled")?"bg-blue-100 text-blue-800":"bg-slate-100 text-slate-600"}function $(){return e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",className:"text-green-600",children:[e.jsx("path",{d:"M9 12l2 2 4-4",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"}),e.jsx("circle",{cx:"12",cy:"12",r:"9",stroke:"currentColor",strokeWidth:"1.5"})]})}}export{he as default};
