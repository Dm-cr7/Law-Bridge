import{b as ue,r,l as xe,t as n,d as u,j as e,U as pe,m as he,X as fe}from"./index-DX-5XR_r.js";import{u as be}from"./index.esm-BEqESI9Z.js";import{a as je,o as ge,c as ve,s as O,_ as we}from"./schemas-CQTzvhsC.js";import{P as Ne}from"./plus-kOBQIic3.js";import{R as ye}from"./refresh-ccw-Dbz6RysH.js";import{S as Se}from"./search-CcuI7EWr.js";import{D as K}from"./download-DmMTyFAX.js";import{T as H}from"./trash-2-C-quUaQj.js";import{C as X}from"./check-DiMJEtlw.js";import{P as ke}from"./pen-BMzHa6rp.js";import{L as Ce}from"./lock-DTmp--nd.js";const Ae="/socket.io",Re="http://localhost:5000",G=[{value:"advocate",label:"Advocate"},{value:"paralegal",label:"Paralegal"},{value:"arbitrator",label:"Arbitrator"},{value:"reconciliator",label:"Reconciliator"},{value:"admin",label:"Admin"},{value:"client",label:"Client"}],_e=ge({name:O().min(2,"Name is required"),email:O().email("Enter a valid email"),role:we(["advocate","paralegal","arbitrator","reconciliator","admin","client"]),password:O().min(6).optional(),active:ve().optional()});function Ie(){const{user:y}=ue(),D=r.useRef(null),[d,x]=r.useState([]),[J,T]=r.useState(!0),[B,_]=r.useState(0),[S,Q]=r.useState(""),[k,W]=r.useState(""),[C,Y]=r.useState(""),[U,I]=r.useState("createdAt:desc"),[j,h]=r.useState(1),[A,Z]=r.useState(20),[c,f]=r.useState(new Set),[M,E]=r.useState(!1),[ee,g]=r.useState(!1),[i,v]=r.useState(null),[q,R]=r.useState(!1),z=r.useRef(d);r.useEffect(()=>{z.current=d},[d]),r.useEffect(()=>{if(!y)return;const s=xe(Re,{path:Ae,transports:["websocket"],withCredentials:!0,auth:{token:localStorage.getItem("token")},query:{userId:y._id,role:y.role}});return D.current=s,s.on("connect",()=>console.info("Admin socket connected",s.id)),s.on("user:created",t=>{x(a=>[t,...a]),_(a=>a+1),n.success(`User created: ${t.name}`)}),s.on("user:updated",t=>{x(a=>a.map(l=>l._id===t._id?t:l)),n.success(`User updated: ${t.name}`)}),s.on("user:statusChanged",({id:t,active:a})=>{x(l=>l.map(o=>o._id===t?{...o,active:a}:o)),n.success(`User ${a?"activated":"deactivated"}`)}),s.on("disconnect",()=>console.warn("Admin socket disconnected")),()=>{s.removeAllListeners(),s.disconnect(),D.current=null}},[y]);const b=r.useCallback(async()=>{T(!0);try{const s={search:S||void 0,role:k||void 0,status:C||void 0,page:j,limit:A,sort:U},a=(await u.get("/users",{params:s})).data;x(Array.isArray(a.data)?a.data:a),_(a.total??(Array.isArray(a.data)?a.data.length:0)),f(new Set),E(!1)}catch(s){console.error("Failed to load users",s),n.error("Failed to load users")}finally{T(!1)}},[S,k,C,j,A,U]);r.useEffect(()=>{b()},[b]);const $=Math.max(1,Math.ceil(B/A)),se=s=>{f(t=>{const a=new Set(t);return a.has(s)?a.delete(s):a.add(s),a})},te=()=>{if(M){f(new Set),E(!1);return}const s=d.map(t=>t._id);f(new Set(s)),E(!0)},{register:w,handleSubmit:ae,reset:P,formState:{errors:m}}=be({resolver:je(_e),defaultValues:{name:"",email:"",role:"paralegal",password:"",active:!0}});r.useEffect(()=>{P(i?{name:i.name,email:i.email,role:i.role,password:"",active:i.active??!0}:{name:"",email:"",role:"paralegal",password:"",active:!0})},[i,P]);const re=async s=>{R(!0);try{const t={...s};t.password||delete t.password;const a=await u.post("/users",t);x(l=>[a.data,...l]),_(l=>l+1),g(!1),n.success("User created")}catch(t){console.error("Create failed",t),n.error(t?.response?.data?.message||"Failed to create user")}finally{R(!1)}},le=async s=>{if(i){R(!0);try{const t={name:s.name,email:s.email,role:s.role,active:s.active};s.password&&(t.password=s.password);const a=await u.put(`/users/${i._id}`,t);x(l=>l.map(o=>o._id===a.data._id?a.data:o)),v(null),n.success("User updated")}catch(t){console.error("Update failed",t),n.error(t?.response?.data?.message||"Failed to update user")}finally{R(!1)}}},ne=async s=>{const t=s.active?`Deactivate ${s.name}?`:`Reactivate ${s.name}?`;if(window.confirm(t))try{await u.put(`/users/${s._id}/status`,{active:!s.active}),x(a=>a.map(l=>l._id===s._1d?{...l,active:!l.active}:l)),b()}catch(a){console.error("Toggle status failed",a),n.error("Failed to change user status")}},ie=async()=>{if(c.size===0)return n.warning("No users selected");if(window.confirm(`Deactivate ${c.size} users?`))try{const s=Array.from(c);await u.put("/users/bulk/status",{ids:s,active:!1}),n.success("Users deactivated"),b()}catch(s){console.error("Bulk deactivate failed",s),n.error("Bulk deactivation failed")}},ce=async()=>{if(c.size===0)return n.warning("No users selected");if(window.confirm(`Reactivate ${c.size} users?`))try{const s=Array.from(c);await u.put("/users/bulk/status",{ids:s,active:!0}),n.success("Users reactivated"),b()}catch(s){console.error("Bulk reactivate failed",s),n.error("Bulk reactivation failed")}},oe=()=>{if(c.size===0)return n.warning("No users selected");const s=z.current.filter(a=>c.has(a._id)),t=V(s);L(t,"users-export.csv","text/csv")},de=async s=>{if(window.confirm(`Send password reset for ${s.email}?`))try{await u.post(`/users/${s._id}/reset-password`),n.success("Password reset requested (email sent)")}catch(t){console.error("Reset password failed",t),n.error("Failed to request password reset")}},me=async()=>{try{const s=await u.get("/users/export",{params:{search:S,role:k,status:C},responseType:"blob"});if(s.data){const t=`users-export-${new Date().toISOString().slice(0,10)}.csv`;L(s.data,t,"text/csv");return}}catch{const t=V(z.current);L(t,`users-export-${new Date().toISOString().slice(0,10)}.csv`,"text/csv")}};function L(s,t,a="text/plain"){const l=s instanceof Blob?s:new Blob([s],{type:a}),o=URL.createObjectURL(l),p=document.createElement("a");p.href=o,p.download=t,document.body.appendChild(p),p.click(),p.remove(),URL.revokeObjectURL(o)}function V(s){if(!Array.isArray(s)||s.length===0)return"";const t=["_id","name","email","role","active","createdAt"],a=[t.join(",")];for(const l of s){const o=t.map(p=>{let N=l[p]??"";return N===!0&&(N="true"),N===!1&&(N="false"),`"${String(N).replace(/"/g,'""')}"`});a.push(o.join(","))}return a.join(`
`)}const F=s=>{const[t,a]=U.split(":");I(t===s?`${s}:${a==="desc"?"asc":"desc"}`:`${s}:desc`)};return e.jsx("div",{className:"min-h-screen p-6 bg-black-50",children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-3 bg-blue-50 rounded text-blue-600",children:e.jsx(pe,{size:26})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"User Management"}),e.jsx("p",{className:"text-sm text-slate-500",children:"Create, edit, and manage platform users in real time."})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:()=>{g(!0),v(null)},className:"inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded",children:[e.jsx(Ne,{size:16})," Create user"]}),e.jsxs("button",{onClick:b,className:"inline-flex items-center gap-2 px-3 py-2 bg-white border rounded",children:[e.jsx(ye,{size:16})," Refresh"]})]})]}),e.jsxs("div",{className:"bg-white p-4 rounded mb-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2 w-full md:w-1/2",children:[e.jsx(Se,{}),e.jsx("input",{"aria-label":"Search users",placeholder:"Search by name, email...",value:S,onChange:s=>{Q(s.target.value),h(1)},className:"w-full border rounded px-3 py-2"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{value:k,onChange:s=>{W(s.target.value),h(1)},className:"border rounded px-2 py-2",children:[e.jsx("option",{value:"",children:"All roles"}),G.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))]}),e.jsxs("select",{value:C,onChange:s=>{Y(s.target.value),h(1)},className:"border rounded px-2 py-2",children:[e.jsx("option",{value:"",children:"All status"}),e.jsx("option",{value:"active",children:"Active"}),e.jsx("option",{value:"inactive",children:"Inactive"})]}),e.jsxs("select",{value:A,onChange:s=>{Z(Number(s.target.value)),h(1)},className:"border rounded px-2 py-2",children:[e.jsx("option",{value:10,children:"10 / page"}),e.jsx("option",{value:20,children:"20 / page"}),e.jsx("option",{value:50,children:"50 / page"})]}),e.jsxs("button",{onClick:me,title:"Export current list (server-side if available)",className:"px-3 py-2 bg-white border rounded inline-flex items-center gap-2",children:[e.jsx(K,{size:16})," Export"]})]})]}),e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:M,onChange:te}),e.jsx("span",{className:"text-sm",children:"Select all on page"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:ie,className:"px-3 py-2 bg-red-600 text-white rounded inline-flex items-center gap-2",children:[e.jsx(H,{size:14})," Deactivate"]}),e.jsxs("button",{onClick:ce,className:"px-3 py-2 bg-green-600 text-white rounded inline-flex items-center gap-2",children:[e.jsx(X,{size:14})," Reactivate"]}),e.jsxs("button",{onClick:oe,className:"px-3 py-2 bg-white border rounded inline-flex items-center gap-2",children:[e.jsx(K,{size:14})," Export CSV"]})]})]}),e.jsxs("div",{className:"text-sm text-slate-500",children:[B," users"]})]}),e.jsx("div",{className:"bg-white rounded shadow overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-slate-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2",children:e.jsx("input",{type:"checkbox",checked:c.size===d.length&&d.length>0,onChange:()=>{c.size===d.length?f(new Set):f(new Set(d.map(s=>s._id)))}})}),e.jsx("th",{className:"p-2 text-left cursor-pointer",onClick:()=>F("name"),children:"Name"}),e.jsx("th",{className:"p-2 text-left cursor-pointer",onClick:()=>F("email"),children:"Email"}),e.jsx("th",{className:"p-2 text-left",children:"Role"}),e.jsx("th",{className:"p-2 text-left cursor-pointer",onClick:()=>F("createdAt"),children:"Created"}),e.jsx("th",{className:"p-2 text-left",children:"Status"}),e.jsx("th",{className:"p-2 text-right",children:"Actions"})]})}),e.jsx("tbody",{children:J?e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"p-6 text-center",children:"Loading users..."})}):d.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"p-6 text-center",children:"No users found"})}):d.map(s=>e.jsxs("tr",{className:"border-b last:border-0 hover:bg-slate-50",children:[e.jsx("td",{className:"p-2",children:e.jsx("input",{checked:c.has(s._id),onChange:()=>se(s._id),type:"checkbox"})}),e.jsxs("td",{className:"p-2",children:[e.jsx("div",{className:"font-medium",children:s.name}),e.jsx("div",{className:"text-xs text-slate-500",children:s.email})]}),e.jsx("td",{className:"p-2",children:s.email}),e.jsx("td",{className:"p-2",children:s.role}),e.jsx("td",{className:"p-2",children:new Date(s.createdAt).toLocaleString()}),e.jsx("td",{className:"p-2",children:s.active?e.jsx("span",{className:"px-2 py-1 bg-green-100 text-green-800 rounded text-xs",children:"Active"}):e.jsx("span",{className:"px-2 py-1 bg-red-100 text-red-800 rounded text-xs",children:"Inactive"})}),e.jsx("td",{className:"p-2 text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("button",{title:"Edit",onClick:()=>{v(s),g(!0)},className:"px-2 py-1 bg-white border rounded inline-flex items-center gap-1",children:e.jsx(ke,{size:14})}),e.jsx("button",{title:"Reset password",onClick:()=>de(s),className:"px-2 py-1 bg-white border rounded inline-flex items-center gap-1",children:e.jsx(Ce,{size:14})}),e.jsx("button",{title:s.active?"Deactivate":"Reactivate",onClick:()=>ne(s),className:`px-2 py-1 rounded inline-flex items-center gap-1 ${s.active?"bg-red-600 text-white":"bg-green-600 text-white"}`,children:s.active?e.jsx(H,{size:14}):e.jsx(X,{size:14})})]})})]},s._id))})]})}),e.jsxs("div",{className:"flex items-center justify-between mt-4",children:[e.jsxs("div",{className:"text-sm text-slate-500",children:["Page ",j," of ",$]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{disabled:j<=1,onClick:()=>h(s=>Math.max(1,s-1)),className:"px-3 py-1 border rounded",children:"Prev"}),e.jsx("button",{disabled:j>=$,onClick:()=>h(s=>Math.min($,s+1)),className:"px-3 py-1 border rounded",children:"Next"})]})]}),ee&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4",children:e.jsxs(he.div,{initial:{scale:.98,opacity:0},animate:{scale:1,opacity:1},className:"bg-white rounded-lg shadow-lg w-full max-w-2xl p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:i?"Edit user":"Create user"}),e.jsx("button",{onClick:()=>{g(!1),v(null)},className:"p-2 rounded hover:bg-slate-100",children:e.jsx(fe,{})})]}),e.jsxs("form",{onSubmit:ae(i?le:re),className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Full name"}),e.jsx("input",{...w("name"),className:"w-full border rounded px-3 py-2"}),m.name&&e.jsx("div",{className:"text-xs text-red-600 mt-1",children:m.name.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Email"}),e.jsx("input",{...w("email"),className:"w-full border rounded px-3 py-2"}),m.email&&e.jsx("div",{className:"text-xs text-red-600 mt-1",children:m.email.message})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Role"}),e.jsx("select",{...w("role"),className:"w-full border rounded px-3 py-2",children:G.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))}),m.role&&e.jsx("div",{className:"text-xs text-red-600 mt-1",children:m.role.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Active"}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",...w("active")}),e.jsx("span",{className:"text-sm",children:"Active"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:i?"Reset password (optional)":"Password"}),e.jsx("input",{...w("password"),type:"password",placeholder:i?"Leave blank to keep current password":"",className:"w-full border rounded px-3 py-2"}),m.password&&e.jsx("div",{className:"text-xs text-red-600 mt-1",children:m.password.message})]}),e.jsxs("div",{className:"flex justify-end gap-3 mt-4",children:[e.jsx("button",{type:"button",onClick:()=>{g(!1),v(null)},className:"px-4 py-2 rounded bg-black-100",children:"Cancel"}),e.jsx("button",{type:"submit",disabled:q,className:"px-4 py-2 rounded bg-blue-600 text-white",children:q?"Saving...":i?"Save changes":"Create"})]})]})]})})]})})}export{Ie as default};
