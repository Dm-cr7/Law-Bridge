import{r as a,u as $,d,l as I,j as e}from"./index-DX-5XR_r.js";import{R as p,P as A,a as D,C as F,L as b,T as g,X as M,Y as O}from"./PieChart-lom7UCbs.js";import{L as T,a as L}from"./LineChart-BuC8iUXl.js";const u=["#4F46E5","#06B6D4","#10B981","#F59E0B","#EF4444"];function m({title:l,value:x,change:o}){return e.jsxs("div",{className:"bg-white shadow-md rounded-2xl p-5 flex flex-col gap-2 border border-gray-200",children:[e.jsx("div",{className:"text-sm text-gray-600",children:l}),e.jsx("div",{className:"text-2xl font-semibold text-gray-900",children:x??"â€”"}),typeof o=="number"&&e.jsxs("div",{className:`text-sm ${o>=0?"text-green-600":"text-red-600"}`,children:[o>=0?"â–²":"â–¼"," ",Math.abs(o),"%"]})]})}const h=()=>e.jsx("div",{className:"bg-gray-200 rounded-xl animate-pulse h-24"}),v=()=>e.jsx("div",{className:"bg-gray-200 rounded-xl animate-pulse h-72"});function G(){const[l,x]=a.useState(null),[o,y]=a.useState([]),[f,N]=a.useState(null),[X,Y]=a.useState([]),[c,R]=a.useState(!0),[B,S]=a.useState(!1),[w,k]=a.useState(null),K=a.useRef(null),C=$();a.useEffect(()=>{async function t(){R(!0);try{const[s,r,n]=await Promise.all([d.get("/reports/cases/summary?scope=self"),d.get("/reports/staff/productivity?scope=self"),d.get("/reports/adr/success?scope=self")]);x(s.data?.data),y(r.data?.data),N(n.data?.data)}catch(s){console.error("âŒ Reports fetch error:",s);const r=s.response?.status;r===401?(localStorage.removeItem("token"),C("/login")):k(r===403?"ðŸš« Access denied.":"Failed to load reports.")}finally{R(!1)}}t()},[C]),a.useEffect(()=>{const t=d?.defaults?.baseURL||void 0||"http://localhost:5000",s=localStorage.getItem("token");if(!s)return;const r=I(`${t}/reports`,{transports:["websocket"],auth:{token:s}});return K.current=r,r.on("connect",()=>S(!0)),r.on("disconnect",()=>S(!1)),r.on("reports:update",n=>{n?.cases&&x(n.cases),n?.staff&&y(n.staff),n?.adr&&N(n.adr)}),()=>r.disconnect()},[]);const E=a.useMemo(()=>(l?.byStatus||[]).map(t=>({name:t.status,value:t.count})),[l]),U=a.useMemo(()=>(o||[]).map(t=>({name:t.name||"Unassigned",completed:t.closedCount||0,total:t.totalAssigned||0})),[o]),P=a.useMemo(()=>(f?.breakdown||[]).map(t=>({name:t._id,value:t.count})),[f]),j=async t=>{try{const s=await d.get(`/reports/export?type=${t}&format=pdf`,{responseType:"blob"}),r=new Blob([s.data],{type:"application/pdf"}),n=window.URL.createObjectURL(r),i=document.createElement("a");i.href=n,i.download=`${t}-report.pdf`,document.body.appendChild(i),i.click(),document.body.removeChild(i)}catch(s){console.error("Export failed:",s),alert("Failed to export PDF report.")}};return w?e.jsxs("div",{className:"p-8 text-center text-red-600 font-semibold",children:["âš ï¸ ",w]}):e.jsxs("div",{className:"p-6 bg-gray-50 min-h-screen text-gray-900",children:[e.jsxs("header",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Reports & Analytics"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Real-time insights unique to your account"})]}),e.jsxs("div",{className:"text-sm text-right",children:[B?"ðŸŸ¢ Live":"ðŸ”´ Offline"," ",e.jsx("br",{}),c?"Loadingâ€¦":"Up to date"]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 mb-6",children:c?e.jsxs(e.Fragment,{children:[e.jsx(h,{})," ",e.jsx(h,{})," ",e.jsx(h,{})," ",e.jsx(h,{})]}):e.jsxs(e.Fragment,{children:[e.jsx(m,{title:"Total Cases",value:l?.total}),e.jsx(m,{title:"Avg Resolution Days",value:l?.avgResolutionDays}),e.jsx(m,{title:"Active Staff",value:o?.length}),e.jsx(m,{title:"ADR Success Rate",value:`${f?.successRate??0}%`})]})}),e.jsxs("div",{className:"bg-white shadow-md rounded-2xl p-5 mb-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Cases by Status"}),e.jsx("button",{onClick:()=>j("cases"),className:"text-sm text-blue-600 hover:underline",children:"â¬‡ Export PDF"})]}),c?e.jsx(v,{}):e.jsx(p,{width:"100%",height:300,children:e.jsxs(A,{children:[e.jsx(D,{data:E,dataKey:"value",outerRadius:100,label:!0,children:E.map((t,s)=>e.jsx(F,{fill:u[s%u.length]},s))}),e.jsx(b,{}),e.jsx(g,{})]})})]}),e.jsxs("div",{className:"bg-white shadow-md rounded-2xl p-5 mb-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Staff Productivity"}),e.jsx("button",{onClick:()=>j("staff"),className:"text-sm text-blue-600 hover:underline",children:"â¬‡ Export PDF"})]}),c?e.jsx(v,{}):e.jsx(p,{width:"100%",height:300,children:e.jsxs(T,{data:U,children:[e.jsx(M,{dataKey:"name"}),e.jsx(O,{}),e.jsx(g,{}),e.jsx(b,{}),e.jsx(L,{dataKey:"completed",stroke:"#10B981"}),e.jsx(L,{dataKey:"total",stroke:"#4F46E5"})]})})]}),e.jsxs("div",{className:"bg-white shadow-md rounded-2xl p-5 mb-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"ADR Success Breakdown"}),e.jsx("button",{onClick:()=>j("adr"),className:"text-sm text-blue-600 hover:underline",children:"â¬‡ Export PDF"})]}),c?e.jsx(v,{}):e.jsx(p,{width:"100%",height:300,children:e.jsxs(A,{children:[e.jsx(D,{data:P,dataKey:"value",outerRadius:120,label:!0,children:P.map((t,s)=>e.jsx(F,{fill:u[s%u.length]},s))}),e.jsx(b,{}),e.jsx(g,{})]})})]})]})}export{G as default};
