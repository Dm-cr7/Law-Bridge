import{b as V,r as u,d as L,j as e,t as c,F as X,u as oe,T as ce,c as Z,l as de}from"./index-DX-5XR_r.js";import{u as me,C as ue}from"./index.esm-BEqESI9Z.js";import{a as pe,o as xe,s as f,_ as J,c as Q}from"./schemas-CQTzvhsC.js";import{P as S}from"./index-B6SWdEHo.js";import{C as ee}from"./cloud-upload-BqI6-c57.js";import{T as te}from"./trash-2-C-quUaQj.js";import{S as he}from"./search-CcuI7EWr.js";import{E as fe}from"./external-link-KfiVAypa.js";import{C as ge}from"./circle-check-big-CsO3dtKP.js";import{D as je}from"./download-DmMTyFAX.js";import{L as be}from"./link-BIoVTXN6.js";const ye=xe({firstName:f().min(1,"First name is required"),middleName:f().optional().nullable(),lastName:f().min(1,"Last name is required"),preferredName:f().optional().nullable(),dateOfBirth:f().optional().nullable(),gender:J(["male","female","other"]).optional().nullable(),idNumber:f().optional().nullable(),email:f().email("Enter a valid email").optional().nullable(),primaryPhone:f().min(6,"Primary phone is required"),secondaryPhone:f().optional().nullable(),addressLine1:f().optional().nullable(),addressLine2:f().optional().nullable(),city:f().optional().nullable(),state:f().optional().nullable(),postalCode:f().optional().nullable(),country:f().optional().nullable(),company:f().optional().nullable(),occupation:f().optional().nullable(),notes:f().optional().nullable(),tags:f().optional().nullable(),consentGiven:Q().optional().default(!1),intakeCase_create:Q().optional().default(!1),intakeCase_title:f().optional().nullable(),intakeCase_category:f().optional().nullable(),intakeCase_priority:J(["low","medium","high","urgent"]).optional().default("medium"),intakeCase_description:f().optional().nullable(),source:f().optional().nullable()}),H=l=>(l||"").toString().replace(/[^\d+]/g,"").trim(),Ne=l=>(l||"").split(",").map(h=>h.trim()).filter(Boolean);function se({categories:l=[],sources:h=[],onSuccess:y}){const{user:A}=V()||{},{register:n,handleSubmit:g,control:_,watch:j,setValue:C,formState:{errors:w,isSubmitting:d},reset:R}=me({resolver:pe(ye),defaultValues:{firstName:"",middleName:"",lastName:"",preferredName:"",dateOfBirth:"",gender:"",idNumber:"",email:"",primaryPhone:"",secondaryPhone:"",addressLine1:"",addressLine2:"",city:"",state:"",postalCode:"",country:"",company:"",occupation:"",notes:"",tags:"",consentGiven:!1,intakeCase_create:!1,intakeCase_title:"",intakeCase_category:l?.[0]||"civil",intakeCase_priority:"medium",intakeCase_description:"",source:""}}),k=u.useRef(null),[U,F]=u.useState(!1),[T,P]=u.useState({}),[r,a]=u.useState([]),[i,N]=u.useState([]),[O,b]=u.useState(!1),s=j("primaryPhone"),p=j("email"),v=j("intakeCase_create"),$=j("consentGiven");u.useEffect(()=>{let t;const x=(p||"").trim()||H(s||"");if(!x){N([]);return}return b(!0),t=setTimeout(async()=>{try{const o=await L.get(`/clients?q=${encodeURIComponent(x)}&limit=5`),m=Array.isArray(o.data)?o.data:o.data?.clients||o.data?.items||[];N(m)}catch(o){console.error("Duplicate check failed:",o)}finally{b(!1)}},600),()=>clearTimeout(t)},[s,p]);const E=async t=>{const x=Array.from(t.target.files||[]);if(!x.length)return;F(!0);const o=[];for(const m of x)try{const D=new FormData;D.append("files",m);const z=((await L.post("/upload/multiple",D,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:W=>{const le=W.total?Math.round(W.loaded*100/W.total):0;P(ie=>({...ie,[m.name]:le}))}})).data?.files||[])[0]||null;if(!z)throw new Error("Upload response missing file details");const ne=m.type.startsWith("image/")?URL.createObjectURL(m):null;o.push({name:z.name||m.name,fileUrl:z.fileUrl,fileKey:z.fileKey,fileType:z.fileType||m.type,size:z.size||m.size,previewUrl:ne})}catch(D){console.error("Upload error:",D),c.error(D?.response?.data?.message||`Failed to upload ${m.name}`)}finally{P(D=>{const K={...D};return delete K[m.name],K})}a(m=>[...m,...o]),F(!1),k.current&&(k.current.value="")},M=async t=>{try{await L.delete("/upload",{data:{fileKey:t}}),a(x=>{const o=x.find(m=>m.fileKey===t);if(o?.previewUrl)try{URL.revokeObjectURL(o.previewUrl)}catch{}return x.filter(m=>m.fileKey!==t)}),c.success("File removed")}catch(x){console.error("Delete file failed:",x),c.error(x?.response?.data?.message||"Failed to remove file")}},B=(t,x="submitted")=>{const o={firstName:t.firstName?.trim()||"",middleName:t.middleName?.trim()||"",lastName:t.lastName?.trim()||"",preferredName:t.preferredName?.trim()||"",dateOfBirth:t.dateOfBirth||null,gender:t.gender||null,idNumber:t.idNumber||null,email:t.email?.trim()?.toLowerCase()||null,primaryPhone:H(t.primaryPhone||""),secondaryPhone:H(t.secondaryPhone||""),address:{line1:t.addressLine1||"",line2:t.addressLine2||"",city:t.city||"",state:t.state||"",postalCode:t.postalCode||"",country:t.country||""},company:t.company||null,occupation:t.occupation||null,notes:t.notes||"",tags:Ne(t.tags||""),consentGiven:!!t.consentGiven,intake:{source:t.source||null,intakeOfficer:A?._id||null,status:x},attachments:r.map(m=>({name:m.name,fileUrl:m.fileUrl,fileKey:m.fileKey,fileType:m.fileType,size:m.size}))};return t.intakeCase_create&&(o.intakeCase={createCase:!0,title:t.intakeCase_title||"",category:t.intakeCase_category||"civil",priority:t.intakeCase_priority||"medium",description:t.intakeCase_description||""}),o},I=async t=>{if(r.length>0&&!t.consentGiven){c.error("Client consent required to upload documents");return}try{const x=B(t,"submitted"),o=await L.post("/clients",x),m=o.data||o;c.success("Client intake submitted"),y?.(m),r.forEach(D=>{if(D.previewUrl)try{URL.revokeObjectURL(D.previewUrl)}catch{}}),a([]),R()}catch(x){console.error("Submit intake failed:",x);const o=x?.response?.data;if(o)if(o.errors&&typeof o.errors=="object"){const m=Object.values(o.errors).map(D=>D.message||D).join(", ");c.error(m)}else o.message?c.error(o.message):c.error("Bad request — check inputs");else c.error("Network or server error")}},q=async t=>{try{const x=B(t,"draft"),o=await L.post("/clients",x),m=o.data||o;c.success("Draft saved"),y?.(m)}catch(x){console.error("Save draft failed:",x);const o=x?.response?.data;o?.message?c.error(o.message):c.error("Failed to save draft")}};function G(){return e.jsxs("div",{className:"border border-gray-200 rounded p-3",children:[e.jsxs("label",{className:"flex items-center gap-3 p-3 border-2 border-dashed rounded cursor-pointer hover:border-blue-400",children:[e.jsx(ee,{}),e.jsx("span",{className:"text-sm text-gray-600",children:U?"Uploading...":"Click or drop files"}),e.jsx("input",{ref:k,type:"file",multiple:!0,onChange:E,className:"hidden",accept:"image/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,text/csv,application/zip,text/plain",disabled:U})]}),Object.keys(T).length>0&&e.jsx("div",{className:"mt-2 space-y-2 text-xs",children:Object.entries(T).map(([t,x])=>e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex-1 truncate",children:t}),e.jsxs("div",{className:"w-20 text-right",children:[x,"%"]})]},t))}),r.length>0&&e.jsx("ul",{className:"mt-3 space-y-2 max-h-40 overflow-auto",children:r.map(t=>e.jsxs("li",{className:"flex items-center justify-between gap-3 p-2 bg-gray-50 rounded",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[t.previewUrl?e.jsx("img",{src:t.previewUrl,alt:t.name,className:"w-10 h-10 rounded object-cover"}):e.jsx("div",{className:"w-10 h-10 rounded bg-gray-200 flex items-center justify-center",children:e.jsx(X,{})}),e.jsxs("div",{className:"text-sm",children:[e.jsx("div",{className:"truncate max-w-xs",children:t.name}),e.jsx("div",{className:"text-xs text-gray-500",children:t.size?`${(t.size/1024).toFixed(1)} KB`:""})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("a",{href:t.fileUrl,target:"_blank",rel:"noreferrer",className:"text-xs text-blue-600 hover:underline",children:"Open"}),e.jsx("button",{type:"button",onClick:()=>M(t.fileKey),title:"Remove",className:"p-2 text-red-600 hover:text-red-800",children:e.jsx(te,{size:14})})]})]},t.fileKey||t.fileUrl))})]})}function re(){return!O&&i.length===0?null:e.jsxs("div",{className:"mt-2 p-3 border border-yellow-200 bg-yellow-50 rounded",children:[e.jsx("div",{className:"text-sm font-semibold",children:"Possible matches"}),O?e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"Checking…"}):e.jsx("ul",{className:"mt-2 space-y-2 text-xs",children:i.length===0?e.jsx("li",{className:"text-gray-500",children:"No similar clients"}):i.map(t=>e.jsxs("li",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium",children:[t.firstName||t.name," ",t.lastName||""]}),e.jsx("div",{className:"text-gray-500",children:t.email||t.primaryPhone}),t.createdBy&&e.jsxs("div",{className:"text-xxs text-gray-400",children:["Created by: ",t.createdBy.name||t.createdBy.email]})]}),e.jsx("div",{children:e.jsx("a",{href:`/dashboard/clients/${t._id}`,className:"text-blue-600 text-xs hover:underline",children:"Open"})})]},t._id))})]})}return e.jsx("form",{onSubmit:g(I),className:"space-y-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"md:col-span-2 space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"First name"}),e.jsx("input",{...n("firstName"),className:"mt-1 w-full p-2 border rounded"}),w.firstName&&e.jsx("p",{className:"text-xs text-red-600 mt-1",children:w.firstName.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Middle name"}),e.jsx("input",{...n("middleName"),className:"mt-1 w-full p-2 border rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Last name"}),e.jsx("input",{...n("lastName"),className:"mt-1 w-full p-2 border rounded"}),w.lastName&&e.jsx("p",{className:"text-xs text-red-600 mt-1",children:w.lastName.message})]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Preferred name"}),e.jsx("input",{...n("preferredName"),className:"mt-1 w-full p-2 border rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Date of birth"}),e.jsx("input",{type:"date",...n("dateOfBirth"),className:"mt-1 w-full p-2 border rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Gender"}),e.jsxs("select",{...n("gender"),className:"mt-1 w-full p-2 border rounded",children:[e.jsx("option",{value:"",children:"Select"}),e.jsx("option",{value:"male",children:"Male"}),e.jsx("option",{value:"female",children:"Female"}),e.jsx("option",{value:"other",children:"Other"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"ID number"}),e.jsx("input",{...n("idNumber"),className:"mt-1 w-full p-2 border rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Email"}),e.jsx("input",{...n("email"),type:"email",className:"mt-1 w-full p-2 border rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Primary phone"}),e.jsx("input",{...n("primaryPhone"),className:"mt-1 w-full p-2 border rounded"}),w.primaryPhone&&e.jsx("p",{className:"text-xs text-red-600 mt-1",children:w.primaryPhone.message})]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Secondary phone"}),e.jsx("input",{...n("secondaryPhone"),className:"mt-1 w-full p-2 border rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Company"}),e.jsx("input",{...n("company"),className:"mt-1 w-full p-2 border rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Occupation"}),e.jsx("input",{...n("occupation"),className:"mt-1 w-full p-2 border rounded"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Address line 1"}),e.jsx("input",{...n("addressLine1"),className:"mt-1 w-full p-2 border rounded"})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"City"}),e.jsx("input",{...n("city"),className:"mt-1 w-full p-2 border rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"State"}),e.jsx("input",{...n("state"),className:"mt-1 w-full p-2 border rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Postal code"}),e.jsx("input",{...n("postalCode"),className:"mt-1 w-full p-2 border rounded"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Notes"}),e.jsx("textarea",{...n("notes"),rows:3,className:"mt-1 w-full p-2 border rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Tags (comma separated)"}),e.jsx("input",{...n("tags"),className:"mt-1 w-full p-2 border rounded",placeholder:"vulnerable, referral"})]}),e.jsx(re,{}),e.jsxs("div",{className:"mt-3 p-3 border rounded",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ue,{control:_,name:"intakeCase_create",render:({field:t})=>e.jsx("input",{type:"checkbox",...t,checked:!!t.value})}),e.jsx("span",{className:"font-medium",children:"Create intake case"})]}),v&&e.jsxs("div",{className:"mt-3 grid grid-cols-1 sm:grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Case title"}),e.jsx("input",{...n("intakeCase_title"),className:"mt-1 w-full p-2 border rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Category"}),e.jsx("select",{...n("intakeCase_category"),className:"mt-1 w-full p-2 border rounded",children:l&&l.length>0?l.map(t=>e.jsx("option",{value:t,children:t},t)):e.jsxs(e.Fragment,{children:[e.jsx("option",{value:"civil",children:"Civil"}),e.jsx("option",{value:"criminal",children:"Criminal"}),e.jsx("option",{value:"adr",children:"ADR"}),e.jsx("option",{value:"other",children:"Other"})]})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Priority"}),e.jsxs("select",{...n("intakeCase_priority"),className:"mt-1 w-full p-2 border rounded",children:[e.jsx("option",{value:"low",children:"Low"}),e.jsx("option",{value:"medium",children:"Medium"}),e.jsx("option",{value:"high",children:"High"}),e.jsx("option",{value:"urgent",children:"Urgent"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Short description"}),e.jsx("input",{...n("intakeCase_description"),className:"mt-1 w-full p-2 border rounded"})]})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Source"}),e.jsxs("select",{...n("source"),className:"mt-1 w-full p-2 border rounded",children:[e.jsx("option",{value:"",children:"Select source"}),Array.isArray(h)&&h.map(t=>e.jsx("option",{value:t,children:t},t)),e.jsx("option",{value:"phone",children:"Phone"}),e.jsx("option",{value:"referral",children:"Referral"}),e.jsx("option",{value:"walk-in",children:"Walk-in"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Attachments"}),e.jsx(G,{}),e.jsx("p",{className:"text-xs text-gray-500 mt-2",children:"Allowed: pdf, doc, docx, images, csv, zip. Max per file depends on server."})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",...n("consentGiven")}),e.jsx("span",{className:"text-sm",children:"Client consent obtained for document upload"})]}),!$&&r.length>0&&e.jsx("p",{className:"text-xs text-red-600 mt-1",children:"Consent required to upload documents"})]}),e.jsxs("div",{className:"flex flex-col gap-2 mt-2",children:[e.jsx("button",{type:"button",onClick:g(q),disabled:d,className:"px-4 py-2 bg-gray-200 rounded",children:"Save Draft"}),e.jsx("button",{type:"submit",disabled:d,className:"px-4 py-2 bg-blue-600 text-white rounded",children:d?"Submitting...":"Submit Intake"})]})]})]})})}se.propTypes={categories:S.array,sources:S.array,onSuccess:S.func};const ve=10*1024*1024,we=["application/pdf","image/jpeg","image/png","image/gif","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","text/plain","text/csv","application/zip"];function ke({files:l=[],setFiles:h,maxFiles:y=20,maxFileSize:A=ve,allowedTypes:n=we,autoUpload:g=!0}){const _=u.useRef(null),[j,C]=u.useState(!1),[w,d]=u.useState({}),[R,k]=u.useState(!1),U=u.useCallback(s=>{typeof h=="function"?h(p=>Array.isArray(p)?[...p,...s].slice(0,y):[...s]):console.warn("Attachments: setFiles is not a function")},[h,y]),F=s=>s.size>A?(c.error(`${s.name} exceeds maximum size of ${(A/1024/1024).toFixed(1)} MB`),!1):n&&n.length>0&&!(n.includes(s.type)||n.some(v=>v.startsWith(".")&&s.name.toLowerCase().endsWith(v)))?(c.error(`Invalid file type: ${s.type||s.name}`),!1):!0,T=async s=>{const p=`${s.name}-${s.size}-${Date.now()}`;try{k(!0),d(I=>({...I,[p]:0}));const v=new FormData;v.append("files",s);const $=await L.post("/upload/multiple",v,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:I=>{const q=I.total?Math.round(I.loaded*100/I.total):0;d(G=>({...G,[p]:q}))}}),E=Array.isArray($.data?.files)&&$.data.files[0]?$.data.files[0]:null;if(!E)throw new Error("Upload failed: missing response");const M=s.type?.startsWith("image/")?URL.createObjectURL(s):null,B={name:E.name||s.name,fileUrl:E.fileUrl,fileKey:E.fileKey,fileType:E.fileType||s.type,size:E.size||s.size,previewUrl:M};return U([B]),B}catch(v){throw console.error("Upload error:",v),c.error(v?.response?.data?.message||`Upload failed: ${s.name}`),v}finally{d(v=>{const $={...v};return delete $[`${s.name}-${s.size}-${Date.now()}`],$}),k(!1)}},P=async s=>{const p=s.filter(F);if(p.length===0)return;const v=p.map($=>T($).catch(E=>null));await Promise.all(v)},r=async s=>{const p=Array.from(s.target.files||[]);p.length!==0&&(g&&await P(p),s.target.value="")},a=async s=>{s.preventDefault(),s.stopPropagation(),C(!1);const p=Array.from(s.dataTransfer?.files||[]);p.length!==0&&g&&await P(p)},i=s=>{s.preventDefault(),s.dataTransfer.dropEffect="copy",C(!0)},N=s=>{s.preventDefault(),C(!1)},O=async s=>{if(s)try{await L.delete("/upload",{data:{fileKey:s}}),typeof h=="function"&&h(p=>Array.isArray(p)?p.filter(v=>v.fileKey!==s):[]),c.success("File deleted")}catch(p){console.error("Delete upload failed:",p),c.error("Failed to delete file")}},b=s=>{s&&window.open(s,"_blank","noopener,noreferrer")};return u.useEffect(()=>()=>{Array.isArray(l)&&l.forEach(s=>{if(s.previewUrl)try{URL.revokeObjectURL(s.previewUrl)}catch{}})},[]),e.jsxs("div",{className:"attachments-component",children:[e.jsxs("div",{className:`rounded border-2 transition p-3 ${j?"border-blue-400 bg-blue-50":"border-dashed border-gray-200 bg-white"}`,onDrop:a,onDragOver:i,onDragEnter:i,onDragLeave:N,children:[e.jsxs("label",{className:"flex items-center justify-between gap-3 cursor-pointer select-none",onClick:()=>_.current?.click(),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded bg-gray-100",children:e.jsx(ee,{})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Click to upload or drag files here"}),e.jsxs("div",{className:"text-xs text-gray-500",children:["Allowed: pdf, doc, docx, images, csv, zip. Max per file: ",(A/1024/1024).toFixed(1)," MB"]})]})]}),e.jsx("div",{children:e.jsx("button",{type:"button",onClick:s=>{s.stopPropagation(),_.current?.click()},className:"px-3 py-1 rounded bg-blue-600 text-white text-sm",children:"Upload"})})]}),e.jsx("input",{ref:_,type:"file",multiple:!0,className:"hidden",onChange:r,accept:n.join(",")}),Object.keys(w).length>0&&e.jsx("div",{className:"mt-3 space-y-2",children:Object.entries(w).map(([s,p])=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("div",{className:"truncate",children:s}),e.jsxs("div",{children:[p,"%"]})]},s))}),Array.isArray(l)&&l.length>0&&e.jsx("ul",{className:"mt-3 space-y-2 max-h-56 overflow-auto",children:l.map(s=>e.jsxs("li",{className:"flex items-center justify-between gap-3 p-2 bg-gray-50 rounded",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[s.previewUrl?e.jsx("img",{src:s.previewUrl,alt:s.name,className:"w-12 h-12 rounded object-cover"}):e.jsx("div",{className:"w-12 h-12 rounded bg-gray-200 flex items-center justify-center",children:e.jsx(X,{})}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"text-sm truncate",children:s.name}),e.jsxs("div",{className:"text-xs text-gray-500",children:[(s.size/1024).toFixed(1)," KB • ",s.fileType]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>b(s.fileUrl),className:"text-xs text-blue-600 hover:underline",children:"Open"}),e.jsx("button",{type:"button",onClick:()=>O(s.fileKey),className:"p-2 text-red-600 hover:text-red-800",title:"Remove",children:e.jsx(te,{size:16})})]})]},s.fileKey))})]}),e.jsx("div",{className:"mt-2 text-xs text-gray-500",children:"Files are uploaded immediately and attached to the intake. You can remove them before submitting — removing will delete the uploaded file from storage."})]})}function ae({query:l,minQueryLength:h=3,debounceMs:y=600,limit:A=5,autoShow:n=!0,onSelect:g=()=>{},showOpenLink:_=!0}){const[j,C]=u.useState([]),[w,d]=u.useState(!1),[R,k]=u.useState(null),U=u.useRef(null),F=u.useRef(""),T=u.useCallback(async a=>{if(!a||a.length<h){C([]),k(null),d(!1);return}d(!0),k(null);try{const i=await L.get(`/clients?q=${encodeURIComponent(a)}&limit=${A}`),N=Array.isArray(i.data)?i.data:i.data?.items||i.data||[];C(N||[])}catch(i){console.error("Duplicate fetch error:",i),k(i?.response?.data?.message||"Failed to fetch duplicates"),C([])}finally{d(!1)}},[A,h]);u.useEffect(()=>{U.current&&clearTimeout(U.current);const a=(l||"").trim();if(F.current=a,!a||a.length<h){C([]),k(null),d(!1);return}return U.current=setTimeout(()=>{F.current===a&&T(a)},y),()=>{U.current&&clearTimeout(U.current)}},[l,y,T,h]);const P=a=>{try{g(a)}catch(i){console.error("onSelect handler error:",i),c.error("Action failed")}},r=()=>{const a=(l||"").trim();if(!a||a.length<h){c.error(`Enter at least ${h} characters to search`);return}T(a)};return e.jsxs("div",{className:"duplicate-check text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2 px-2 py-1 rounded bg-gray-50 border border-gray-200",children:[e.jsx(he,{size:14}),e.jsx("div",{className:"text-xs text-gray-600",children:w?"Searching for duplicates…":j.length?`${j.length} possible match(es)`:"No matches"})]}),e.jsx("button",{type:"button",onClick:r,className:"ml-auto text-xs px-2 py-1 rounded bg-white border border-gray-200 hover:shadow",title:"Refresh",children:"Refresh"})]}),e.jsx("div",{className:"bg-white border border-gray-100 rounded",children:R?e.jsx("div",{className:"p-3 text-xs text-red-600",children:R}):w?e.jsx("div",{className:"p-3 text-xs text-gray-500",children:"Looking up possible duplicates…"}):!j||j.length===0?n?e.jsx("div",{className:"p-3 text-xs text-gray-500",children:"No similar clients found."}):null:e.jsx("ul",{className:"divide-y",children:j.map(a=>e.jsxs("li",{className:"p-3 flex items-start justify-between",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"font-medium truncate",children:(a.firstName||a.name||"")+(a.lastName?` ${a.lastName}`:"")}),e.jsxs("div",{className:"text-xs text-gray-500 truncate",children:[" ",a.email||a.primaryPhone||a.phone||""]})]}),a.address?.line1&&e.jsx("div",{className:"text-xs text-gray-400 mt-1 truncate",children:a.address.line1})]}),e.jsxs("div",{className:"flex items-center gap-2 ml-3",children:[e.jsx("button",{type:"button",onClick:()=>P(a),className:"px-2 py-1 text-xs bg-blue-600 text-white rounded",title:"Select this client",children:"Select"}),_&&e.jsxs("a",{href:`/dashboard/clients/${a._id}`,title:"Open client",className:"text-xs text-blue-600 hover:underline flex items-center gap-1",children:["Open ",e.jsx(fe,{size:12})]})]})]},a._id))})})]})}ae.propTypes={query:S.string,minQueryLength:S.number,debounceMs:S.number,limit:S.number,autoShow:S.bool,onSelect:S.func,showOpenLink:S.bool};function Ce(l){if(!l)return"";const h=l.firstName||l.first_name||l.name||"",y=l.lastName||l.last_name||"";return`${h} ${y}`.trim()||"(Unnamed)"}function Y({data:l,onNewIntake:h,showLocalToaster:y=!1}){const A=oe(),n=l?.client||(l&&l._id?l:null),g=l?.case||l?.intakeCase||null,_=Array.isArray(n?.attachments)?n.attachments:[],j=()=>{if(!n?._id){c.error("Client id missing");return}A(`/dashboard/clients/${n._id}`)},C=()=>{if(!g?._id){c.error("Case id missing");return}A(`/dashboard/cases/${g._id}`)},w=d=>{if(!d){c.error("No file URL available");return}window.open(d,"_blank","noopener,noreferrer")};return e.jsxs("div",{className:"intake-success min-h-[60vh] flex items-start justify-center p-6",children:[y&&e.jsx(ce,{position:"top-right"}),e.jsxs("div",{className:"w-full max-w-3xl bg-white rounded-lg shadow p-6",children:[e.jsxs("div",{className:"flex items-center gap-4 mb-4",children:[e.jsx("div",{className:"rounded-full bg-green-100 text-green-700 p-3",children:e.jsx(ge,{size:28})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-semibold",children:"Intake Completed"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"The client intake was created successfully. Use the actions below to proceed."})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-6",children:[e.jsxs("div",{className:"p-4 border rounded",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Client"}),n?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 font-medium",children:[e.jsx(Z,{}),e.jsx("div",{children:Ce(n)})]}),e.jsxs("div",{className:"text-sm text-gray-600 mt-2",children:[e.jsx("div",{children:n.email||"—"}),e.jsx("div",{children:n.primaryPhone||n.phone||"—"})]})]}):e.jsx("div",{className:"text-sm text-gray-500",children:"No client data returned"})]}),e.jsxs("div",{className:"p-4 border rounded",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Case (if created)"}),g?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"font-medium",children:g.title||g.caseNumber||"Untitled Case"}),e.jsx("div",{className:"text-sm text-gray-600 mt-2",children:g.caseNumber?`Case # ${g.caseNumber}`:""})]}):e.jsx("div",{className:"text-sm text-gray-500",children:"No case created"})]}),e.jsxs("div",{className:"p-4 border rounded",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Attachments"}),_.length>0?e.jsx("ul",{className:"space-y-2 text-sm",children:_.map((d,R)=>{const k=d.fileKey||d.fileUrl||`${R}`,U=d.name||(typeof d.fileUrl=="string"?d.fileUrl.split("/").pop():`Attachment ${R+1}`);return e.jsxs("li",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"truncate",children:[e.jsx("div",{className:"font-medium",children:U}),d.fileType&&e.jsx("div",{className:"text-xs text-gray-500",children:d.fileType})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:()=>w(d.fileUrl),className:"text-xs px-2 py-1 bg-blue-50 text-blue-700 rounded flex items-center gap-1",title:"Open / download",children:[e.jsx(je,{size:14})," Open"]}),e.jsxs("a",{href:d.fileUrl,target:"_blank",rel:"noreferrer noopener",className:"text-xs text-blue-600 hover:underline flex items-center gap-1",title:"Open in new tab",children:[e.jsx(be,{size:12})," Link"]})]})]},k)})}):e.jsx("div",{className:"text-sm text-gray-500",children:"No attachments"})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("button",{onClick:j,className:"px-4 py-2 rounded bg-blue-600 text-white flex items-center gap-2",title:"View client details",children:[e.jsx(Z,{})," View Client"]}),e.jsxs("button",{onClick:C,disabled:!g,className:`px-4 py-2 rounded flex items-center gap-2 ${g?"bg-indigo-600 text-white":"bg-gray-100 text-gray-500 cursor-not-allowed"}`,title:g?"View case":"No case created",children:[e.jsx(X,{})," View Case"]}),e.jsx("button",{onClick:()=>{try{h?.(),c("Ready for new intake")}catch{c.error("Unable to start new intake")}},className:"px-4 py-2 rounded bg-white border text-gray-700",children:"Create Another Intake"})]})]})]})}Y.propTypes={data:S.oneOfType([S.object,S.array]),onNewIntake:S.func,showLocalToaster:S.bool};Y.defaultProps={data:null,onNewIntake:null,showLocalToaster:!1};const Ue="http://localhost:5000",Se="/socket.io";function ze(){const{user:l}=V()||{},[h,y]=u.useState(!1),[A,n]=u.useState(!1),[g,_]=u.useState(null),[j,C]=u.useState([]),[w,d]=u.useState([]),[R,k]=u.useState(null);u.useEffect(()=>{if(!l||!l._id)return;const r=de(Ue,{path:Se,transports:["websocket"],withCredentials:!0,auth:{token:localStorage.getItem("authToken")||sessionStorage.getItem("authToken")},query:{userId:l._id,role:l.role}});return r.on("connect",()=>{console.debug("Intake socket connected:",r.id)}),r.on("client:created",a=>{c.success(`New client created: ${a.name}`)}),r.on("connect_error",a=>{console.warn("Intake socket connect_error:",a?.message||a)}),k(r),()=>{try{r.removeAllListeners(),r.disconnect()}catch{}k(null)}},[l]),u.useMemo(()=>({createdBy:l?._id||null}),[l]);const U=async({email:r,phone:a})=>{try{if(!r&&!a)return[];y(!0);const i=r?`email=${encodeURIComponent(r)}`:`phone=${encodeURIComponent(a)}`,N=await L.get(`/clients?${i}`),O=Array.isArray(N.data)?N.data:[];return d(O.slice(0,5)),O}catch(i){return console.debug("Duplicate check error:",i?.response?.data||i),d([]),[]}finally{y(!1)}},F=async r=>{try{n(!0),j?.length&&(r.attachments=j);const a=await L.post("/clients",r),i=a.data?.client||a.data;return _(i),c.success("Client created successfully"),C([]),i}catch(a){console.error("Intake create failed:",a);const i=a?.response?.data?.message||a.message||"Failed to create client";throw c.error(i),a}finally{n(!1)}},T=async r=>{if(!r||!r.length)return[];y(!0);const a=[];try{const i=new FormData;r.forEach(b=>i.append("files",b));const{data:N}=await L.post("/upload/multiple",i,{headers:{"Content-Type":"multipart/form-data"}});return(N?.files||N?.files||[]).forEach(b=>a.push({name:b.name||(b.fileUrl?b.fileUrl.split("/").pop():"file"),fileUrl:b.fileUrl,fileKey:b.fileKey,fileType:b.fileType,size:b.size})),C(b=>[...b||[],...a]),c.success(`${a.length} file(s) uploaded`),a}catch(i){console.error("Upload failed:",i);const N=i?.response?.data?.message||"Upload failed";return c.error(N),[]}finally{y(!1)}},P=async r=>{try{if(!r||!r.fileUrl)return;if(new URL(r.fileUrl,window.location.origin).origin===window.location.origin){window.open(r.fileUrl,"_blank");return}const i=localStorage.getItem("authToken")||sessionStorage.getItem("authToken");if(i){const N=await fetch(r.fileUrl,{headers:{Authorization:`Bearer ${i}`}});if(!N.ok)throw new Error("Failed to download file");const O=await N.blob(),b=URL.createObjectURL(O),s=document.createElement("a");s.href=b,s.download=r.name||"download",document.body.appendChild(s),s.click(),s.remove(),URL.revokeObjectURL(b);return}window.open(r.fileUrl,"_blank")}catch(a){console.error("Download failed:",a),c.error("Unable to download file")}};return g?e.jsx("div",{className:"intake-page p-6",children:e.jsx(Y,{client:g,onCreateAnother:()=>_(null),onDownloadAll:()=>{const r=g.attachments||j||[];if(!r.length)return c("No attachments to download");r.forEach(a=>P(a))}})}):e.jsxs("div",{className:"intake-page p-6",children:[e.jsxs("header",{className:"mb-6 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Client Intake"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Add new clients, upload documents, and run duplicate checks."})]}),e.jsx("div",{children:e.jsxs("small",{className:"text-xs text-gray-500",children:["Signed in as: ",l?.name||"Unknown"]})})]}),e.jsxs("main",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("section",{className:"lg:col-span-2 space-y-4",children:[e.jsx("div",{className:"bg-white p-4 rounded-lg shadow-sm",children:e.jsx(se,{onSubmit:async r=>{const a=await U({email:r.email,phone:r.phone});if(a&&a.length&&!window.confirm(`Found ${a.length} possible duplicate(s). Do you still want to create a new client?`)){d(a);return}try{const i=await F(r);R&&R.connected}catch{}},submitting:A,loading:h})}),e.jsxs("div",{className:"bg-white p-4 rounded-lg shadow-sm",children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Attachments"}),e.jsx("p",{className:"text-sm text-gray-500 mb-3",children:"Upload any files relevant to this intake (IDs, documents)."}),e.jsx(ke,{attachments:j,onUpload:T,onRemove:r=>{C(a=>a.filter(i=>i.fileKey!==r&&i.fileUrl!==r))},onDownload:r=>P(r),uploading:h})]})]}),e.jsxs("aside",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-white p-4 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"font-semibold",children:"Duplicate check"}),e.jsx("small",{className:"text-xs text-gray-500",children:"Quick search"})]}),e.jsx(ae,{onCheck:U,recent:w,onSelectExisting:r=>{_(r)}})]}),e.jsxs("div",{className:"bg-white p-4 rounded-lg shadow-sm",children:[e.jsx("h4",{className:"font-semibold",children:"Tips"}),e.jsxs("ul",{className:"text-sm text-gray-600 list-disc list-inside mt-2",children:[e.jsx("li",{children:"Run duplicate check before creating a new client."}),e.jsx("li",{children:"Upload identification documents in Attachments."}),e.jsx("li",{children:"Share the client record with the relevant advocate/paralegal after creation."})]})]})]})]})]})}export{ze as default};
