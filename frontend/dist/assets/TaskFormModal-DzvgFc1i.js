import{r as u,b as q,d as y,j as e,A as W,m as F,C as X,U as G,F as J}from"./index-DX-5XR_r.js";import{z as n}from"./index-DFuZcw6R.js";import{C as Q}from"./circle-x-Dq1y862S.js";import{C as V}from"./cloud-upload-BqI6-c57.js";import{T as K}from"./trash-2-C-quUaQj.js";const Y=new Set(["application/pdf","image/jpeg","image/png","image/webp","image/gif","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","text/plain","application/zip"]),Z=new Set([".pdf",".jpg",".jpeg",".png",".gif",".doc",".docx",".txt",".zip"]);function ee(f){if(!f)return"";const j=["B","KB","MB","GB"],b=Math.floor(Math.log(f)/Math.log(1024));return`${(f/Math.pow(1024,b)).toFixed(1)} ${j[b]}`}function ne({isOpen:f,onClose:j,onSuccess:b,caseId:S,existingTask:c}){const N=u.useRef(),{user:te,token:o}=q(),w=!!c,[E,R]=u.useState([]),[v,C]=u.useState(!1),[T,z]=u.useState({}),[A,k]=u.useState(!1),[m,h]=u.useState({title:"",description:"",priority:"medium",dueDate:"",assignedTo:[],attachments:[]}),[p,x]=u.useState([]);u.useEffect(()=>{if(c){h({title:c.title||"",description:c.description||"",priority:c.priority||"medium",dueDate:c.dueDate?c.dueDate.slice(0,10):"",assignedTo:c.assignedTo?.map(s=>s._id?s._id:s)||[],attachments:c.attachments||[]});const t=(c.attachments||[]).map((s,r)=>({id:`existing-${r}-${s.fileKey||s.name}`,file:null,previewUrl:s.fileUrl&&/\.(jpg|jpeg|png|gif|webp)$/i.test(s.fileUrl)?s.fileUrl:null,name:s.name||(s.fileUrl?s.fileUrl.split("/").pop():`Attachment ${r+1}`),size:s.size||0,fileType:s.fileType||"",uploaded:!0,fileKey:s.fileKey||s.name,fileUrl:s.fileUrl}));x(t)}},[c]),u.useEffect(()=>{f||(p.forEach(t=>{t.previewObjectUrl&&URL.revokeObjectURL(t.previewObjectUrl)}),h({title:"",description:"",priority:"medium",dueDate:"",assignedTo:[],attachments:[]}),x([]),z({}))},[f]),u.useEffect(()=>{f&&(async()=>{try{const t=await y.get("/users",{headers:o?{Authorization:`Bearer ${o}`}:void 0});R(t.data||[])}catch(t){console.error("❌ Failed to fetch users:",t),n.error("Failed to load users")}})()},[f,o]);const U=t=>{const{name:s,value:r}=t.target;h(i=>({...i,[s]:r}))},B=t=>{const s=Array.from(t.target.selectedOptions,r=>r.value);h(r=>({...r,assignedTo:s}))},L=t=>{if(Y.has(t.type))return!0;const r=t.name&&t.name.includes(".")&&t.name.substring(t.name.lastIndexOf(".")).toLowerCase()||"";return!!(r&&Z.has(r))},M=t=>{const s=Array.from(t.target.files||[]);if(!s.length)return;const r=s.filter(l=>!L(l));if(r.length){const l=r.map(g=>`${g.name} (${g.type||"unknown"})`).join(", ");n.error(`Invalid file type: ${l}`);return}const i=s.map((l,g)=>{const a=/^image\//.test(l.type)?URL.createObjectURL(l):null;return{id:`local-${Date.now()}-${g}-${l.name}`,file:l,previewObjectUrl:a,previewUrl:a,name:l.name,size:l.size,fileType:l.type,uploaded:!1,fileKey:null,fileUrl:null}});x(l=>[...i,...Array.isArray(l)?l:[]])},$=async()=>{const t=p.filter(r=>!r.uploaded&&r.file);if(!t.length)return;C(!0);const s=new FormData;t.forEach(r=>s.append("files",r.file));try{const r=await y.post("/upload/multiple",s,{headers:{Authorization:o?`Bearer ${o}`:void 0,"Content-Type":"multipart/form-data"},onUploadProgress:a=>{const d=a.total?Math.round(a.loaded*100/a.total):0;z(H=>({...H,all:d}))}}),i=r.data?.files||r.data?.data?.files||[];if(!i.length){n.error("Upload returned no files");return}const l=[...p];let g=0;for(let a=0;a<l.length&&g<i.length;a++)if(!l[a].uploaded&&l[a].file){const d=i[g++];l[a]={...l[a],uploaded:!0,fileKey:d.fileKey||d.fileKey||d.filename||d.key||d.fileUrl&&d.fileUrl.split("/").pop(),fileUrl:d.fileUrl||d.url||null,name:d.name||l[a].name,fileType:d.fileType||l[a].fileType,size:d.size||l[a].size}}const D=l.filter(a=>a.uploaded&&a.fileUrl).map(a=>({name:a.name,fileUrl:a.fileUrl,fileKey:a.fileKey,fileType:a.fileType,size:a.size}));h(a=>({...a,attachments:[...a.attachments||[],...D]})),x(l),n.success(`${i.length} file(s) uploaded`)}catch(r){console.error("❌ Upload failed:",r,r?.response?.data);const i=r?.response?.data?.message||r?.response?.data?.error;n.error(i||"Upload failed")}finally{C(!1),z({})}},P=async t=>{const s=p.find(r=>r.id===t);if(s){if(s.uploaded&&s.fileKey)try{await y.delete("/upload",{headers:o?{Authorization:`Bearer ${o}`}:void 0,data:{fileKey:s.fileKey}}),h(r=>({...r,attachments:(r.attachments||[]).filter(i=>i.fileKey!==s.fileKey&&i.fileUrl!==s.fileUrl)})),n.success("Attachment removed")}catch(r){console.error("❌ Failed to delete uploaded file:",r,r?.response?.data);const i=r?.response?.data?.message||r?.response?.data?.error;n.error(i||"Failed to delete file from server");return}s.previewObjectUrl&&URL.revokeObjectURL(s.previewObjectUrl),x(r=>r.filter(i=>i.id!==t))}},I=async t=>{if(t.preventDefault(),!m.title.trim())return n.error("Task title is required");if(!m.dueDate)return n.error("Due date is required");if(!m.assignedTo?.length)return n.error("Select at least one assignee");p.filter(r=>!r.uploaded&&r.file).length&&(n("Uploading files first..."),await $());try{k(!0);const r={...m,caseId:S};w?(await y.put(`/tasks/${c._id}`,r,{headers:o?{Authorization:`Bearer ${o}`}:void 0}),n.success("Task updated successfully")):(await y.post("/tasks",r,{headers:o?{Authorization:`Bearer ${o}`}:void 0}),n.success("Task created successfully")),b?.(),j()}catch(r){console.error("❌ Save error:",r,r?.response?.data);const i=r?.response?.data?.message||r?.response?.data?.error;n.error(i||"Failed to save task")}finally{k(!1)}},O=t=>{N.current&&!N.current.contains(t.target)&&j()},_=t=>{const s=!!t.previewUrl&&/\.(jpg|jpeg|png|gif|webp)$/i.test(t.previewUrl);return e.jsxs("div",{className:"flex items-center gap-3 p-2 border rounded-md",children:[e.jsx("div",{className:"w-14 h-14 flex items-center justify-center bg-gray-50 rounded-md overflow-hidden",children:s?e.jsx("img",{src:t.previewUrl,alt:t.name,className:"object-cover w-full h-full"}):e.jsx(J,{size:28,className:"text-gray-500"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-medium text-gray-800 truncate",children:t.name}),e.jsx("div",{className:"text-xs text-gray-500",children:ee(t.size)}),v&&T.all!=null&&e.jsx("div",{className:"w-full bg-gray-100 rounded-full h-2 mt-1",children:e.jsx("div",{className:"h-2 rounded-full transition-all",style:{width:`${T.all}%`}})})]}),e.jsxs("div",{className:"flex flex-col items-end gap-2",children:[t.uploaded&&t.fileUrl?e.jsx("a",{href:t.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"text-xs text-blue-600 hover:underline",children:"Open"}):e.jsx("span",{className:"text-xs text-gray-400",children:"Pending"}),e.jsxs("button",{onClick:()=>P(t.id),className:"text-red-600 hover:text-red-800 flex items-center gap-1 text-xs",title:"Remove",children:[e.jsx(K,{size:14}),"Remove"]})]})]},t.id)};return e.jsx(W,{children:f&&e.jsx(F.div,{onMouseDown:O,className:"fixed inset-0 bg-black/40 z-50 flex items-center justify-center overflow-y-auto",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:e.jsx(F.div,{ref:N,className:"bg-white w-full max-w-xl rounded-xl shadow-lg relative my-10 overflow-hidden",initial:{y:50,opacity:0},animate:{y:0,opacity:1},exit:{y:50,opacity:0},children:e.jsxs("div",{className:"max-h-[85vh] overflow-y-auto p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4 sticky top-0 bg-white z-10 pb-2 border-b",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-800",children:w?"Edit Task":"Create Task"}),e.jsx("button",{onClick:j,className:"text-gray-500 hover:text-gray-700",children:e.jsx(Q,{size:22})})]}),e.jsxs("form",{onSubmit:I,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Title"}),e.jsx("input",{type:"text",name:"title",value:m.title,onChange:U,className:"w-full border border-gray-300 rounded-lg px-3 py-2 mt-1 focus:ring-2 focus:ring-blue-500",placeholder:"Enter task title"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Description"}),e.jsx("textarea",{name:"description",value:m.description,onChange:U,rows:3,className:"w-full border border-gray-300 rounded-lg px-3 py-2 mt-1 focus:ring-2 focus:ring-blue-500",placeholder:"Describe the task"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Priority"}),e.jsxs("select",{name:"priority",value:m.priority,onChange:U,className:"w-full border border-gray-300 rounded-lg px-3 py-2 mt-1",children:[e.jsx("option",{value:"low",children:"Low"}),e.jsx("option",{value:"medium",children:"Medium"}),e.jsx("option",{value:"high",children:"High"}),e.jsx("option",{value:"urgent",children:"Urgent"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"text-sm font-medium text-gray-700 flex items-center gap-2",children:[e.jsx(X,{size:16})," Due Date"]}),e.jsx("input",{type:"date",name:"dueDate",value:m.dueDate,onChange:U,className:"w-full border border-gray-300 rounded-lg px-3 py-2 mt-1"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"text-sm font-medium text-gray-700 flex items-center gap-2",children:[e.jsx(G,{size:16})," Assign To"]}),e.jsx("select",{name:"assignedTo",multiple:!0,value:m.assignedTo||[],onChange:B,className:"w-full border border-gray-300 rounded-lg px-3 py-2 mt-1 h-28",children:E.map(t=>e.jsxs("option",{value:t._id,children:[t.name," (",t.role,")"]},t._id))}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Hold ",e.jsx("kbd",{children:"Ctrl"})," or ",e.jsx("kbd",{children:"Cmd"})," to select multiple"]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Attachments"}),e.jsxs("label",{className:"flex items-center justify-center gap-2 border-2 border-dashed border-gray-300 rounded-lg py-4 cursor-pointer hover:border-blue-400 text-gray-500 mt-1",children:[e.jsx(V,{size:18}),v?"Uploading...":"Click or drop files",e.jsx("input",{type:"file",multiple:!0,onChange:M,className:"hidden",disabled:v})]}),p.length>0&&e.jsx("div",{className:"mt-3 grid grid-cols-1 gap-2",children:p.map(t=>_(t))}),p.some(t=>!t.uploaded&&t.file)&&e.jsxs("div",{className:"mt-2 flex gap-2",children:[e.jsx("button",{type:"button",onClick:$,disabled:v,className:"px-3 py-1.5 bg-blue-600 text-white rounded-md text-sm hover:bg-blue-700",children:v?"Uploading...":"Upload Files"}),e.jsx("button",{type:"button",onClick:()=>{p.forEach(t=>{t.previewObjectUrl&&URL.revokeObjectURL(t.previewObjectUrl)}),x(t=>t.filter(s=>s.uploaded))},className:"px-3 py-1.5 bg-gray-100 rounded-md text-sm hover:bg-gray-200",children:"Clear Pending"})]}),m.attachments?.length>0&&e.jsx("ul",{className:"text-sm text-gray-600 mt-2 space-y-1",children:m.attachments.map((t,s)=>e.jsxs("li",{className:"flex items-center justify-between",children:[e.jsx("a",{href:t.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:underline",children:t.name||t.fileUrl.split("/").pop()}),e.jsxs("button",{type:"button",onClick:async()=>{try{await y.delete("/upload",{headers:o?{Authorization:`Bearer ${o}`}:void 0,data:{fileKey:t.fileKey}}),h(r=>({...r,attachments:(r.attachments||[]).filter(i=>i.fileKey!==t.fileKey)})),n.success("Attachment removed")}catch(r){console.error("❌ Failed to remove attachment:",r),n.error("Failed to remove attachment")}},className:"text-red-600 hover:text-red-800 flex items-center gap-1 text-xs",children:[e.jsx(K,{size:14}),"Remove"]})]},s))})]}),e.jsx("button",{type:"submit",disabled:A,className:"w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition disabled:opacity-50",children:A?w?"Updating...":"Creating...":w?"Update Task":"Create Task"})]})]})})})})}export{ne as T};
