import{R as oe,j as t,b as we,r as n,d as E,C as _e,B as F,n as Pe,e as Re,h as De}from"./index-DX-5XR_r.js";import{C as Te,a as Ae,b as Ee,c as qe}from"./Card-BJc8c6SY.js";import{I as S}from"./Input-BOJvGKkg.js";import{z as M}from"./index-DFuZcw6R.js";import{i as le}from"./format-FvBShcrJ.js";import{C as ke}from"./circle-x-Dq1y862S.js";function de(...m){return m.flat(1/0).filter(Boolean).join(" ")}const u=oe.forwardRef(({className:m,...g},l)=>t.jsx("label",{ref:l,className:de("block text-sm font-medium text-gray-700 mb-1",m),...g}));u.displayName="Label";const ue=oe.forwardRef(({className:m,...g},l)=>t.jsx("textarea",{ref:l,className:de("w-full rounded-md border border-gray-300 px-3 py-2 text-sm shadow-sm","focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500","placeholder:text-gray-400","disabled:cursor-not-allowed disabled:opacity-60",m),...g}));ue.displayName="Textarea";const ce=12,Be=[{value:"advocates",label:"Advocate"},{value:"arbitrators",label:"Arbitrator"},{value:"clients",label:"Client"},{value:"respondents",label:"Respondent"}];function Me({arbitrationId:m=null,defaultCaseId:g=null,socket:l=null,onCreated:me=null}){const{user:Le}=we()||{},[U,x]=n.useState([]),[h,W]=n.useState(g||""),[G,X]=n.useState([]),[w,he]=n.useState(""),[Z,J]=n.useState(1),[fe,xe]=n.useState(!1),[_,K]=n.useState(""),[P,Q]=n.useState(""),[R,V]=n.useState(""),[z,ge]=n.useState(Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC"),[p,Y]=n.useState(""),[q,ee]=n.useState(""),[D,N]=n.useState([]),[te,se]=n.useState([]),[C,H]=n.useState({enabled:!1,minutesBefore:30}),[f,k]=n.useState({freq:"none",interval:1,count:1}),[B,ae]=n.useState(!1),[pe,re]=n.useState(!1),[O,ne]=n.useState(!1),[je,T]=n.useState(!1),j=n.useRef(!0),b=n.useRef(null),v=n.useRef(null),A=n.useRef(null),y=n.useCallback(e=>typeof e=="string"?M(e):e?.type==="error"?M.error(e.message||e.title||"Error"):M.success(e.message||e.title||"Done"),[]);n.useEffect(()=>(j.current=!0,be(),l&&l.on&&(l.on("hearing:new",e=>x(a=>[e,...a])),l.on("hearing:update",e=>x(a=>a.map(s=>(s._id||s.id)===(e._id||e.id)?e:s))),l.on("hearing:deleted",e=>{const a=e?._id||e?.id||e;x(s=>s.filter(r=>(r._id||r.id)!==a))})),()=>{if(j.current=!1,b.current)try{b.current.abort()}catch{}if(v.current)try{v.current.abort()}catch{}if(l&&l.off)try{l.off("hearing:new"),l.off("hearing:update"),l.off("hearing:deleted")}catch{}}),[m,l]);async function be(){re(!0);try{b.current&&b.current.abort(),b.current=new AbortController;const e=m?`/arbitrations/${m}/hearings`:"/hearings",a=await E.get(e,{signal:b.current.signal}),s=Array.isArray(a?.data)?a.data:a?.data?.data??a?.data??[];if(!j.current)return;x(s)}catch(e){e?.name==="AbortError"||e?.code==="ERR_CANCELED"||(console.error("Error fetching hearings:",e),y({type:"error",message:e?.response?.data?.message||e?.message||"Failed to load hearings"}))}finally{j.current&&re(!1),b.current=null}}n.useEffect(()=>(A.current&&clearTimeout(A.current),A.current=setTimeout(()=>{J(1),$({q:w,page:1})},300),()=>{A.current&&clearTimeout(A.current)}),[w]);async function $({q:e="",page:a=1}={}){try{v.current&&v.current.abort(),v.current=new AbortController;const s=await E.get("/cases",{params:{q:e,page:a,limit:ce},signal:v.current.signal}),r=Array.isArray(s?.data)?s.data:s?.data?.data??s?.data??[],c=s?.data?.meta??s?.meta??{};if(!j.current)return;X(a===1?r:i=>[...i,...r]),xe(!!(c?.total&&r.length+(a-1)*ce<c.total))}catch(s){s?.name==="AbortError"||s?.code==="ERR_CANCELED"||(console.error("Error loading cases:",s),y({type:"error",message:"Failed to load cases"}))}finally{v.current=null}}n.useEffect(()=>{if(!h){se([]),N([]);return}const e=new AbortController;return(async()=>{try{const a=await E.get(`/cases/${h}`,{signal:e.signal}),s=a?.data?.data??a?.data??a,c=((Array.isArray(s?.participants)?s.participants:s?.sharedWith??[])||[]).map(i=>typeof i=="string"?{_id:i,name:i}:{_id:i._id||i.id||i,name:i.name||i.email||String(i._id||i.id),email:i.email,role:i.role});if(s?.client){const i=typeof s.client=="string"?{_id:s.client,name:s.client}:{_id:s.client._id||s.client.id,name:s.client.name||s.client.email};c.some(o=>String(o._id)===String(i._id))||c.unshift(i)}if(s?.respondent){const i=typeof s.respondent=="string"?{_id:s.respondent,name:s.respondent}:{_id:s.respondent._id||s.respondent.id,name:s.respondent.name||s.respondent.email};c.some(o=>String(o._id)===String(i._id))||c.unshift(i)}if(j.current){se(c);const i=[];s?.client&&(s.client._id||typeof s.client=="string")&&i.push(String(s.client._id??s.client)),s?.filedBy&&i.push(String(s.filedBy));const o=c.filter(d=>i.includes(String(d._id))).map(d=>({id:d._id,name:d.name,role:s.client&&String(s.client._id??s.client)===String(d._id)?"clients":"advocates"}));N(o)}}catch(a){a?.name==="AbortError"||a?.code==="ERR_CANCELED"||console.error("Failed to load case participants",a)}})(),()=>{try{e.abort()}catch{}}},[h]);function ve(){if(!h)return{ok:!1,message:"Case is required"};if(!_||!_.trim())return{ok:!1,message:"Title is required"};if(!P)return{ok:!1,message:"Date is required"};if(!R)return{ok:!1,message:"Time is required"};const e=new Date(`${P}T${R}`);return isNaN(e.valueOf())?{ok:!1,message:"Date/time invalid"}:{ok:!0,start:e.toISOString()}}function ye(e){const a=e._id||e.id,s=D.some(r=>String(r.id)===String(a));N(s?r=>r.filter(c=>String(c.id)!==String(a)):r=>[...r,{id:a,name:e.name||e.email||a,role:"advocates"}])}function Ne(e,a){N(s=>s.map(r=>String(r.id)===String(e)?{...r,role:a}:r))}function Ce(){const e={advocates:[],arbitrators:[],clients:[],respondents:[]};return(D||[]).forEach(a=>{const s=a.role||"advocates";e[s]||(e[s]=[]),e[s].push(a.id)}),e}async function ie(e){e?.preventDefault?.();const a=ve();if(!a.ok){y({type:"error",message:a.message});return}ne(!0);const s=Ce(),r={caseId:h,title:_.trim(),start:a.start,timezone:z,end:null,venue:p&&!/^https?:\/\//i.test(p)?p:null,meetingLink:/^https?:\/\//i.test(p)?p:null,description:q||"",participants:s,arbitration:m||null,reminder:C.enabled?{minutesBefore:Number(C.minutesBefore)||30}:null,recurrence:f.freq!=="none"?f:null,status:B?"draft":"scheduled"},c=`temp_${Date.now()}`,i={_id:c,title:r.title,start:r.start,case:{_id:h},description:r.description,status:r.status};x(o=>[i,...o]);try{const o=await E.post("/hearings",r),d=o?.data?.data??o?.data??o;x(I=>[d,...I.filter(L=>L._id!==c&&L.id!==c)]),y({type:"success",message:B?"Draft saved":"Hearing scheduled"});try{l?.emit&&l.emit("hearing:new",d)}catch{}me?.(d),K(""),g||W(""),Q(""),V(""),Y(""),ee(""),N([]),H({enabled:!1,minutesBefore:30}),k({freq:"none",interval:1,count:1}),ae(!1)}catch(o){console.error("Create hearing failed",o);const d=o?.response?.data?.message||o?.message||"Failed to create hearing";y({type:"error",message:d}),x(I=>I.filter(L=>L._id!==c))}finally{j.current&&ne(!1)}}async function Se(e){if(confirm("Cancel this hearing?"))try{await E.delete(`/hearings/${e}`),x(a=>a.filter(s=>(s._id||s.id)!==e)),y({type:"success",message:"Hearing cancelled"});try{l?.emit&&l.emit("hearing:deleted",e)}catch{}}catch(a){console.error("Cancel failed",a),y({type:"error",message:a?.response?.data?.message||a?.message||"Failed to cancel hearing"})}}return t.jsxs(Te,{className:"shadow-md border border-gray-100",children:[t.jsx(Ae,{children:t.jsxs(Ee,{className:"text-lg font-semibold flex items-center gap-2",children:[t.jsx(_e,{className:"w-5 h-5"})," Hearing Scheduler"]})}),t.jsxs(qe,{children:[t.jsxs("form",{onSubmit:ie,className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-6",children:[t.jsxs("div",{className:"md:col-span-2",children:[t.jsx(u,{htmlFor:"caseSearch",children:"Case (search)"}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(S,{id:"caseSearch",placeholder:"Search cases by title or case number",value:w,onChange:e=>he(e.target.value),className:"flex-1"}),t.jsx("button",{type:"button",onClick:()=>$({q:w,page:Z}),className:"px-3 py-1 rounded border bg-slate-50",children:"Search"})]}),t.jsxs("div",{className:"mt-2 flex gap-2 items-center",children:[t.jsxs("select",{value:h,onChange:e=>W(e.target.value),className:"w-full border rounded px-2 py-1","aria-label":"Select case",required:!0,children:[t.jsx("option",{value:"",children:g?"(Using context case)":"Pick a case..."}),G.map(e=>t.jsx("option",{value:e._id||e.id,children:e.caseNumber?`${e.caseNumber} — ${e.title}`:e.title||e.name||e._id||e.id},e._id||e.id))]}),fe&&t.jsx("button",{type:"button",onClick:()=>{const e=Z+1;J(e),$({q:w,page:e})},className:"px-2 py-1 border rounded",children:"More"})]}),t.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"If you schedule from a case page, the case will be prefilled and participants auto-loaded."})]}),t.jsxs("div",{children:[t.jsx(u,{htmlFor:"title",children:"Title (required)"}),t.jsx(S,{id:"title",placeholder:"e.g. Preliminary hearing",value:_,onChange:e=>K(e.target.value),required:!0})]}),t.jsxs("div",{children:[t.jsx(u,{htmlFor:"date",children:"Date (required)"}),t.jsx(S,{id:"date",type:"date",value:P,onChange:e=>Q(e.target.value),required:!0})]}),t.jsxs("div",{children:[t.jsx(u,{htmlFor:"time",children:"Time (required)"}),t.jsx(S,{id:"time",type:"time",value:R,onChange:e=>V(e.target.value),required:!0})]}),t.jsxs("div",{children:[t.jsx(u,{htmlFor:"timezone",children:"Timezone"}),t.jsx(S,{id:"timezone",value:z,onChange:e=>ge(e.target.value)}),t.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Defaults to your browser timezone. Server should accept ISO timestamp."})]}),t.jsxs("div",{className:"md:col-span-2",children:[t.jsx(u,{htmlFor:"location",children:"Location or Meeting Link"}),t.jsx(S,{id:"location",placeholder:"Physical venue or https://...",value:p,onChange:e=>Y(e.target.value)})]}),t.jsxs("div",{className:"md:col-span-2",children:[t.jsx(u,{htmlFor:"notes",children:"Notes"}),t.jsx(ue,{id:"notes",rows:3,placeholder:"Meeting link, agenda, or notes",value:q,onChange:e=>ee(e.target.value)})]}),t.jsxs("div",{children:[t.jsx(u,{children:"Participants (from selected case)"}),t.jsxs("div",{className:"border rounded p-2 max-h-36 overflow-auto space-y-1",children:[te.length===0?t.jsx("div",{className:"text-xs text-gray-500",children:"No participants found for selected case."}):null,te.map(e=>{const a=e._id||e.id,s=D.find(r=>String(r.id)===String(a));return t.jsxs("div",{className:"flex items-center gap-2 justify-between",children:[t.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[t.jsx("input",{type:"checkbox",checked:!!s,onChange:()=>ye(e)}),t.jsx("span",{children:e.name||e.email||a})]}),s&&t.jsx("select",{value:s.role,onChange:r=>Ne(a,r.target.value),className:"text-xs border rounded px-2 py-1",children:Be.map(r=>t.jsx("option",{value:r.value,children:r.label},r.value))})]},a)})]}),t.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Select participants and assign their role (advocate, arbitrator, client, respondent)."})]}),t.jsxs("div",{children:[t.jsx(u,{children:"Reminder"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"checkbox",checked:C.enabled,onChange:()=>H(e=>({...e,enabled:!e.enabled}))}),t.jsx("input",{type:"number",min:"1",value:C.minutesBefore,onChange:e=>H(a=>({...a,minutesBefore:e.target.value})),className:"w-24 border rounded px-2 py-1"}),t.jsx("span",{className:"text-sm text-gray-600",children:"minutes before"})]}),t.jsx(u,{className:"mt-2",children:"Recurrence (optional)"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("select",{value:f.freq,onChange:e=>k(a=>({...a,freq:e.target.value})),className:"border rounded px-2 py-1",children:[t.jsx("option",{value:"none",children:"None"}),t.jsx("option",{value:"daily",children:"Daily"}),t.jsx("option",{value:"weekly",children:"Weekly"}),t.jsx("option",{value:"monthly",children:"Monthly"})]}),t.jsx("input",{type:"number",min:"1",value:f.interval,onChange:e=>k(a=>({...a,interval:Number(e.target.value)})),className:"w-20 border rounded px-2 py-1"}),t.jsx("span",{className:"text-sm",children:"interval"}),t.jsx("input",{type:"number",min:"1",value:f.count,onChange:e=>k(a=>({...a,count:Number(e.target.value)})),className:"w-20 border rounded px-2 py-1"}),t.jsx("span",{className:"text-sm",children:"occurrences"})]})]}),t.jsxs("div",{className:"md:col-span-2 flex items-center gap-3",children:[t.jsx(F,{type:"button",onClick:()=>T(!0),className:"bg-white border",children:"Preview"}),t.jsxs(F,{type:"submit",disabled:O,className:Pe("flex items-center gap-2",O&&"opacity-60"),children:[O?t.jsx(Re,{className:"h-4 w-4 animate-spin"}):t.jsx(De,{className:"h-4 w-4"}),B?"Save Draft":"Schedule Hearing"]}),t.jsxs("label",{className:"flex items-center gap-2 text-sm ml-2",children:[t.jsx("input",{type:"checkbox",checked:B,onChange:()=>ae(e=>!e)}),"Save as draft"]})]})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-semibold mb-2",children:"Upcoming hearings"}),pe?t.jsx("div",{className:"text-sm text-gray-500",children:"Loading..."}):U.length===0?t.jsx("div",{className:"text-sm text-gray-500",children:"No hearings yet."}):t.jsx("ul",{className:"divide-y",children:U.map(e=>t.jsxs("li",{className:"py-2 flex justify-between items-start",children:[t.jsxs("div",{children:[t.jsx("div",{className:"font-medium",children:e.title||e.case?.title||"(Untitled)"}),t.jsx("div",{className:"text-xs text-gray-500",children:e.start?le(new Date(e.start||e.date),"PPP p"):"TBD"}),e.description&&t.jsx("div",{className:"text-xs text-gray-500 mt-1",children:e.description})]}),t.jsxs("div",{className:"flex flex-col items-end gap-2",children:[t.jsx("button",{className:"text-sm text-indigo-600",onClick:()=>{},children:"Open"}),t.jsx("button",{className:"text-sm text-red-600",onClick:()=>Se(e._id||e.id),children:"Cancel"})]})]},e._id||e.id))})]})]}),je&&t.jsxs("div",{className:"fixed inset-0 flex items-center justify-center z-50",children:[t.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:()=>T(!1)}),t.jsxs("div",{className:"bg-white rounded p-4 w-[min(800px,95%)] z-10 shadow-lg",children:[t.jsxs("div",{className:"flex justify-between items-center mb-3",children:[t.jsx("h3",{className:"text-lg font-semibold",children:"Preview Hearing"}),t.jsx("button",{onClick:()=>T(!1),className:"text-gray-600",children:t.jsx(ke,{})})]}),t.jsxs("div",{children:[t.jsxs("p",{children:[t.jsx("strong",{children:"Title:"})," ",_]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Case:"})," ",G.find(e=>(e._id||e.id)===h)?.title||h]}),t.jsxs("p",{children:[t.jsx("strong",{children:"When:"})," ",P&&R?le(new Date(`${P}T${R}`),"PPP p"):"TBD"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Timezone:"})," ",z]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Location:"})," ",p||"TBD"]}),q&&t.jsxs("p",{children:[t.jsx("strong",{children:"Notes:"})," ",q]}),C.enabled&&t.jsxs("p",{children:[t.jsx("strong",{children:"Reminder:"})," ",C.minutesBefore," minutes before"]}),f.freq!=="none"&&t.jsxs("p",{children:[t.jsx("strong",{children:"Recurrence:"})," ",f.freq," every ",f.interval," × (",f.count," times)"]}),D.length>0&&t.jsxs("p",{children:[t.jsx("strong",{children:"Participants:"})," ",D.map(e=>`${e.name} (${e.role})`).join(", ")]})]}),t.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[t.jsx(F,{onClick:()=>T(!1),children:"Close"}),t.jsx(F,{onClick:e=>{T(!1),ie(e)},className:"bg-blue-600 text-white",children:"Confirm & Schedule"})]})]})]})]})}export{Me as default};
