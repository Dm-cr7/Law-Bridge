import{r as l,u as O,l as I,j as e}from"./index-f8gYbhCl.js";import{a as u}from"./api-BYptnXG6.js";import{R as y,P as L,a as P,C as F,L as g,T as N,X as M,Y as U}from"./PieChart-BHf6O0Tn.js";import{L as q,a as $}from"./LineChart-Gw1HkRV_.js";import"./index-Dgkh_OCz.js";function h({title:c,value:o,change:n}){return e.jsxs("div",{className:"bg-white shadow-md rounded-2xl p-5 flex flex-col gap-2 border border-black-100",children:[e.jsx("div",{className:"text-sm text-black-600",children:c}),e.jsx("div",{className:"text-2xl font-semibold text-black",children:o??"â€”"}),typeof n=="number"&&e.jsxs("div",{className:`text-sm ${n>=0?"text-green-600":"text-red-600"}`,children:[n>=0?"â–²":"â–¼"," ",Math.abs(n),"%"]})]})}const j=()=>e.jsx("div",{className:"bg-black-200 rounded-xl animate-pulse h-24 w-full"}),p=()=>e.jsx("div",{className:"bg-black-200 rounded-xl animate-pulse h-72 w-full"});function W(c,o){if(!Array.isArray(o))return c;const n=new Set(c.map(d=>d.id));return[...o.filter(d=>!n.has(d.id)),...c].slice(0,100)}function H(){const[c,o]=l.useState(null),[n,k]=l.useState([]),[d,K]=l.useState(null),[S,T]=l.useState([]),[x,R]=l.useState(!0),[B,w]=l.useState(!1),[A,b]=l.useState(null),C=l.useRef(null),E=O(),m=["#4F46E5","#06B6D4","#10B981","#F59E0B","#EF4444"];l.useEffect(()=>{let t=!0;async function r(){R(!0),b(null);try{const[s,a,i]=await Promise.all([u.get("/reports/cases/summary"),u.get("/reports/staff/productivity"),u.get("/reports/adr/success")]);if(!t)return;o(s.data?.data??s.data??{}),k(a.data?.data??a.data??[]),K(i.data?.data??i.data??{})}catch(s){const a=s?.response?.status;if(console.error("âŒ Error fetching reports:",s),a===401){localStorage.removeItem("token"),E("/login");return}b(a===403?"ðŸš« Access denied: insufficient permissions.":"Failed to load analytics data.")}finally{t&&R(!1)}}return r(),()=>{t=!1}},[E]),l.useEffect(()=>{const t=u?.defaults?.baseURL||void 0||"http://localhost:5000",r=localStorage.getItem("token");if(!r)return;const s=I(`${t}/reports`,{transports:["websocket"],auth:{token:r},reconnectionAttempts:5,reconnectionDelay:2e3});return C.current=s,s.on("connect",()=>{w(!0),console.info("âœ… Connected to reports socket:",s.id)}),s.on("disconnect",()=>{w(!1),console.warn("âš ï¸ Reports socket disconnected")}),s.on("reports:summary",a=>{a&&o(i=>({...i||{},...a.kpis||{},byStatus:a.casesOverTime?.byStatus??i?.byStatus}))}),s.on("reports:casesOverTime",a=>{o(i=>({...i||{},byStatus:a.byStatus??i?.byStatus}))}),s.on("reports:activity",a=>{T(i=>W(i,[a]))}),s.on("reports:error",a=>{console.error("Reports socket error:",a)}),()=>{try{s.disconnect()}catch{}C.current=null}},[]);const f=l.useMemo(()=>(c?.byStatus||[]).map(t=>({name:t.status,value:t.count})),[c]),D=l.useMemo(()=>(n||[]).map(t=>({name:t.name||"Unassigned",completed:t.closedCount||0,total:t.totalAssigned||0})),[n]),v=l.useMemo(()=>(d?.breakdown||[]).map(t=>({name:t._id,value:t.count})),[d]);return A?e.jsxs("div",{className:"p-8 text-center text-red-600 font-semibold",children:["âš ï¸ ",A]}):e.jsxs("div",{className:"p-6 bg-black-50 min-h-screen text-black",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Reports & Analytics"}),e.jsx("p",{className:"text-sm text-black-600",children:"Real-time insights unique to your account"})]}),e.jsxs("div",{className:"text-right text-sm",children:[e.jsx("div",{children:B?"ðŸŸ¢ Live":"ðŸ”´ Offline"}),e.jsx("div",{className:"text-xs text-black-500",children:x?"Loadingâ€¦":"Up to date"})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 mb-6",children:x?e.jsxs(e.Fragment,{children:[e.jsx(j,{})," ",e.jsx(j,{})," ",e.jsx(j,{})," ",e.jsx(j,{})]}):e.jsxs(e.Fragment,{children:[e.jsx(h,{title:"Total Cases",value:c?.total}),e.jsx(h,{title:"Avg Resolution Days",value:c?.avgResolutionDays}),e.jsx(h,{title:"Active Staff",value:(n||[]).length}),e.jsx(h,{title:"ADR Success Rate",value:`${d?.successRate??0}%`})]})}),e.jsxs("div",{className:"bg-white shadow-md rounded-2xl p-5 mb-6",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Cases by Status"}),x?e.jsx(p,{}):f.length===0?e.jsx("div",{className:"text-black-400 text-sm text-center py-8",children:"No case data available"}):e.jsx(y,{width:"100%",height:300,children:e.jsxs(L,{children:[e.jsx(P,{dataKey:"value",data:f,outerRadius:100,label:t=>`${t.name} (${t.value})`,children:f.map((t,r)=>e.jsx(F,{fill:m[r%m.length]},r))}),e.jsx(g,{}),e.jsx(N,{})]})})]}),e.jsxs("div",{className:"bg-white shadow-md rounded-2xl p-5 mb-6",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Staff Productivity"}),x?e.jsx(p,{}):D.length===0?e.jsx("div",{className:"text-black-400 text-sm text-center py-8",children:"No productivity data"}):e.jsx(y,{width:"100%",height:300,children:e.jsxs(q,{data:D,children:[e.jsx(M,{dataKey:"name"}),e.jsx(U,{}),e.jsx(N,{}),e.jsx(g,{}),e.jsx($,{type:"monotone",dataKey:"completed",stroke:"#10B981"}),e.jsx($,{type:"monotone",dataKey:"total",stroke:"#4F46E5"})]})})]}),e.jsxs("div",{className:"bg-white shadow-md rounded-2xl p-5 mb-6",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"ADR Success Breakdown"}),x?e.jsx(p,{}):v?.length?e.jsx(y,{width:"100%",height:300,children:e.jsxs(L,{children:[e.jsx(P,{dataKey:"value",data:v,outerRadius:120,label:t=>`${t.name} (${t.value})`,children:v.map((t,r)=>e.jsx(F,{fill:m[r%m.length]},r))}),e.jsx(g,{}),e.jsx(N,{})]})}):e.jsx("div",{className:"text-black-400 text-sm text-center py-8",children:"No ADR data available"})]}),e.jsxs("div",{className:"bg-white shadow-md rounded-2xl p-5",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Recent Activity"}),x?e.jsx(p,{}):S.length===0?e.jsx("div",{className:"text-black-400 text-sm text-center py-6",children:"No recent activity yet."}):e.jsx("div",{className:"overflow-auto max-h-96",children:e.jsxs("table",{className:"min-w-full table-auto",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-sm text-black-500 border-b",children:[e.jsx("th",{className:"px-4 py-2",children:"When"}),e.jsx("th",{className:"px-4 py-2",children:"User"}),e.jsx("th",{className:"px-4 py-2",children:"Role"}),e.jsx("th",{className:"px-4 py-2",children:"Action"})]})}),e.jsx("tbody",{children:S.map(t=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"px-4 py-2 text-sm text-black-700",children:new Date(t.timestamp).toLocaleString()}),e.jsx("td",{className:"px-4 py-2 text-sm",children:t.user}),e.jsx("td",{className:"px-4 py-2 text-sm text-black-700",children:t.role}),e.jsx("td",{className:"px-4 py-2 text-sm",children:t.description})]},t.id))})]})})]}),e.jsxs("div",{className:"mt-6 text-xs text-black-500 text-center",children:["Each chart and metric is unique to your user account.",e.jsx("br",{}),"Data updates automatically via REST + WebSocket."]})]})}export{H as default};
