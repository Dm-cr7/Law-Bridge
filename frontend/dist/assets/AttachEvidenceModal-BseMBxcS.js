import{b as U,r as i,j as e,A as _,m as f,U as E,p as P,s as k,X as T,q as L,F as R}from"./index-DX-5XR_r.js";import{z as h,n as A}from"./index-DFuZcw6R.js";import{a as w}from"./axiosInstance-QS7N9QFl.js";import{C as I}from"./circle-x-Dq1y862S.js";import{C as M}from"./clock-BQTrMZWA.js";import{P as O}from"./square-pen-W0nZhq9X.js";import{C as W}from"./cloud-upload-BqI6-c57.js";import{T as X}from"./trash-2-C-quUaQj.js";function ee({caseData:t,onClose:l,onShared:j}){const{user:o,token:m}=U(),[u,x]=i.useState(""),[p,a]=i.useState([]),[n,b]=i.useState(t?.sharedWith?.map(s=>s._id)||[]),[C,r]=i.useState(!1),[c,g]=i.useState(!1),d=i.useRef(null),v=String(t?.filedBy?._id||t?.filedBy)===String(o?._id);i.useEffect(()=>{!v&&o.role!=="admin"&&(h.error("Only the case owner or admin can manage sharing."),l?.())},[v,o,l]);const N=async(s="")=>{try{r(!0);const S=((await w.get("/api/users",{headers:{Authorization:`Bearer ${m}`},params:s?{q:s}:{}})).data||[]).filter(B=>B._id!==o._id);a(S)}catch(y){console.error("âŒ Error fetching users:",y),h.error(y.response?.data?.message||"Failed to load users.")}finally{r(!1)}};i.useEffect(()=>{N()},[o,m]),i.useEffect(()=>(d.current&&clearTimeout(d.current),d.current=setTimeout(()=>N(u),300),()=>clearTimeout(d.current)),[u]);const $=async()=>{try{g(!0);const s=await w.patch(`/api/cases/${t._id}/share`,{sharedWith:n},{headers:{Authorization:`Bearer ${m}`}});h.success("âœ… Case shared successfully."),j?.(s.data),l?.()}catch(s){console.error("âŒ Share case error:",s),h.error(s.response?.data?.message||"Failed to share case.")}finally{g(!1)}},F=s=>b(y=>y.includes(s)?y.filter(S=>S!==s):[...y,s]);return e.jsx(_,{children:t&&e.jsx(f.div,{className:"fixed inset-0 bg-black/40 flex items-center justify-center z-50",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:e.jsxs(f.div,{className:"bg-white w-full max-w-lg rounded-xl shadow-lg p-6 relative",initial:{y:40,opacity:0},animate:{y:0,opacity:1},exit:{y:40,opacity:0},children:[e.jsx("button",{className:"absolute top-3 right-3 text-gray-400 hover:text-gray-600",onClick:l,title:"Close",children:e.jsx(I,{size:22})}),e.jsxs("h2",{className:"text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2",children:[e.jsx(E,{size:20}),"Share Case Access"]}),e.jsxs("p",{className:"text-sm text-gray-600 mb-4",children:["Grant access to other registered users for:",e.jsx("br",{}),e.jsx("span",{className:"text-blue-600 font-medium",children:t.title})]}),e.jsx("input",{type:"text",placeholder:"Search users by name or email...",value:u,onChange:s=>x(s.target.value),className:"w-full border border-gray-300 rounded-lg px-3 py-2 mb-4 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"}),C?e.jsx("p",{className:"text-gray-500 text-center py-4",children:"Loading available users..."}):p.length===0?e.jsx("p",{className:"text-gray-500 text-center py-4",children:"No users found."}):e.jsx("div",{className:"max-h-64 overflow-y-auto border border-gray-200 rounded-lg divide-y divide-gray-100",children:p.map(s=>e.jsxs("label",{className:"flex items-center justify-between px-4 py-2 hover:bg-gray-50 cursor-pointer",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-medium text-gray-800",children:s.name}),e.jsx("span",{className:"text-xs text-gray-500",children:s.email})]}),e.jsx("input",{type:"checkbox",checked:n.includes(s._id),onChange:()=>F(s._id),className:"accent-blue-600 w-4 h-4"})]},s._id))}),e.jsxs("div",{className:"flex justify-end gap-3 mt-6",children:[e.jsx("button",{onClick:l,className:"px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-800 text-sm font-medium",children:"Cancel"}),e.jsx("button",{onClick:$,disabled:c,className:"px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium disabled:opacity-60",children:c?"Saving...":"Save Changes"})]})]})})})}const q="http://localhost:5000/api",G=q.replace(/\/+$/,""),z=P.create({baseURL:G,withCredentials:!0,headers:{"Content-Type":"application/json",Accept:"application/json"}});z.interceptors.request.use(t=>{const l=localStorage.getItem("token");return l&&typeof l=="string"&&(t.headers.Authorization=`Bearer ${l}`),t},t=>Promise.reject(t));z.interceptors.response.use(t=>t,t=>(t.response?.status===401&&(console.warn("Unauthorized: clearing session and redirecting..."),localStorage.removeItem("token"),localStorage.removeItem("role"),window.location.pathname!=="/login"&&(window.location.href="/login")),Promise.reject(t)));function te({caseData:t,onClose:l}){const{token:j}=U(),[o,m]=i.useState([]),[u,x]=i.useState(!0),p=async()=>{try{x(!0);const a=await z.get(`/cases/${t._id}/timeline`,{headers:{Authorization:`Bearer ${j}`}});m(a.data?.timeline||[])}catch(a){console.error("âŒ Timeline fetch failed:",a),A.error("Failed to load case timeline")}finally{x(!1)}};return i.useEffect(()=>{if(!t||!k)return;p();const a=n=>{n.caseId===t._id&&(m(b=>[n,...b]),A.success(`ðŸ”„ New case activity: ${n.action}`))};return k.on("case:activity",a),()=>k.off("case:activity",a)},[t]),t?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm",children:e.jsxs(f.div,{initial:{opacity:0,y:40},animate:{opacity:1,y:0},exit:{opacity:0,y:20},transition:{duration:.25},className:"relative w-full max-w-2xl bg-white rounded-2xl shadow-xl p-6",children:[e.jsx("button",{onClick:l,className:"absolute top-3 right-3 text-gray-500 hover:text-gray-700 transition","aria-label":"Close",children:e.jsx(T,{size:20})}),e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(M,{className:"text-blue-600",size:20}),e.jsxs("h2",{className:"text-lg font-semibold text-gray-800",children:["Case Timeline â€” ",e.jsx("span",{className:"text-blue-700",children:t.title})]})]}),e.jsxs("div",{className:"bg-blue-50 border border-blue-100 rounded-lg p-3 mb-4 text-sm text-gray-700",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Status:"})," ",t.status||"Unknown"," Â |Â ",e.jsx("strong",{children:"Category:"})," ",t.category||"Uncategorized"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Filed By:"})," ",t.filedBy?.name||"Unknown"," Â |Â ",e.jsx("strong",{children:"Client:"})," ",t.clientName||"N/A"]})]}),e.jsx("div",{className:"max-h-[65vh] overflow-y-auto pr-2",children:u?e.jsx("div",{className:"text-center text-gray-500 py-6",children:"Loading timeline..."}):o.length===0?e.jsx("div",{className:"text-center text-gray-500 py-6",children:"No activity yet."}):e.jsx("ul",{className:"relative border-l border-gray-200 pl-5",children:o.map((a,n)=>e.jsxs(f.li,{initial:{opacity:0,x:-10},animate:{opacity:1,x:0},transition:{delay:n*.05},className:"mb-5 relative",children:[e.jsx("span",{className:"absolute -left-[7px] top-1 w-3 h-3 rounded-full bg-blue-500"}),e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-800 font-medium",children:a.action||"Activity"}),a.details&&e.jsx("p",{className:"text-sm text-gray-600 mt-0.5",children:a.details}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:new Date(a.timestamp).toLocaleString()})]}),e.jsx(L,{size:16,className:"text-gray-400 mt-1 flex-shrink-0"})]})]},a._id||n))})})]})}):null}function se({caseData:t,onClose:l,onUpdated:j}){const{token:o}=U(),[m,u]=i.useState(t?.evidence||[]),[x,p]=i.useState(!1),[a,n]=i.useState(0),b=async r=>{const c=r.target.files?.[0];if(!c)return;const g=new FormData;g.append("file",c);try{p(!0),n(0);const{data:d}=await w.post(`/api/cases/${t._id}/upload`,g,{headers:{Authorization:`Bearer ${o}`,"Content-Type":"multipart/form-data"},onUploadProgress:v=>{const N=Math.round(v.loaded*100/v.total);n(N)}});u(d.evidence||[]),j?.(d),h.success("ðŸ“Ž Evidence uploaded successfully")}catch(d){console.error("âŒ Upload error:",d),h.error(d.response?.data?.message||"Failed to upload evidence")}finally{p(!1),n(0),r.target.value=null}},C=async r=>{if(window.confirm("Are you sure you want to delete this evidence?"))try{await w.delete(`/api/cases/${t._id}/evidence/${r}`,{headers:{Authorization:`Bearer ${o}`}}),u(c=>c.filter(g=>g._id!==r)),h.success("ðŸ—‘ï¸ Evidence deleted")}catch(c){console.error("âŒ Delete error:",c),h.error(c.response?.data?.message||"Failed to delete file")}};return t?e.jsx(_,{children:e.jsx(f.div,{className:"fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:e.jsxs(f.div,{initial:{opacity:0,y:40},animate:{opacity:1,y:0},exit:{opacity:0,y:40},transition:{duration:.25},className:"relative bg-white w-full max-w-lg max-h-[90vh] overflow-y-auto rounded-2xl shadow-xl p-6",children:[e.jsx("button",{onClick:l,className:"absolute top-3 right-3 text-gray-500 hover:text-gray-700 transition","aria-label":"Close modal",children:e.jsx(T,{size:22})}),e.jsxs("div",{className:"flex items-center gap-2 mb-5",children:[e.jsx(O,{className:"text-emerald-600 w-5 h-5"}),e.jsxs("h2",{className:"text-lg font-semibold text-gray-800",children:["Attach Evidence â€”"," ",e.jsx("span",{className:"text-emerald-700",children:t.title})]})]}),e.jsxs("div",{className:"mb-5",children:[e.jsxs("label",{className:`flex items-center justify-center gap-2 px-4 py-2 rounded-lg cursor-pointer font-medium text-white transition ${x?"bg-gray-400 cursor-not-allowed":"bg-emerald-500 hover:bg-emerald-600"}`,children:[e.jsx(W,{size:18}),x?"Uploading...":"Upload File",e.jsx("input",{type:"file",onChange:b,className:"hidden",disabled:x})]}),x&&e.jsx("div",{className:"mt-3 w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-emerald-500 h-2 rounded-full transition-all duration-300",style:{width:`${a}%`}})})]}),e.jsx("div",{className:"max-h-[55vh] overflow-y-auto",children:m.length===0?e.jsx("p",{className:"text-gray-500 text-sm",children:"No evidence uploaded yet."}):e.jsx("ul",{className:"divide-y divide-gray-100",children:m.map(r=>e.jsxs("li",{className:"py-3 flex items-center justify-between group",children:[e.jsxs("div",{className:"flex items-center gap-2 overflow-hidden",children:[e.jsx(R,{size:18,className:"text-gray-500 flex-shrink-0"}),e.jsx("a",{href:r.fileUrl||r.url,target:"_blank",rel:"noopener noreferrer",className:"text-sm text-blue-600 hover:underline truncate max-w-[240px]",children:r.name||r.originalName||"Unnamed Document"})]}),e.jsx("button",{onClick:()=>C(r._id),className:"text-red-500 hover:text-red-700 opacity-0 group-hover:opacity-100 transition","aria-label":"Delete file",children:e.jsx(X,{size:18})})]},r._id||r.fileKey))})})]})})}):null}export{se as A,te as C,ee as S};
