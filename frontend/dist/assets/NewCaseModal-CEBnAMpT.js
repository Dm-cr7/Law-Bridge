import{b as le,r as s,j as e,A as ne,m as L,I as ie,U as oe}from"./index-DX-5XR_r.js";import{a as b}from"./axiosInstance-QS7N9QFl.js";import{z as m}from"./index-DFuZcw6R.js";import{C as ce}from"./circle-x-Dq1y862S.js";import{F as de}from"./folder-kanban-yQguAe-O.js";import{C as ue}from"./cloud-upload-BqI6-c57.js";const j=u=>{if(!u)return null;if(u?.data===void 0)return u;const p=u.data;return p===void 0?u:p?.data!==void 0?p.data:p};function ye({isOpen:u,onClose:p,onSuccess:q}){const{user:A,token:K}=le()||{},x=K||localStorage.getItem("token")||localStorage.getItem("authToken")||null,[n,v]=s.useState({title:"",description:"",clientId:"",respondentId:"",category:"civil",priority:"medium",attachments:[],sharedWith:[]}),[O,V]=s.useState([]),[X,G]=s.useState([]),[J,Q]=s.useState([]),[D,R]=s.useState(!1),[I,N]=s.useState(0),[P,_]=s.useState(!1),[z,F]=s.useState(!1),[w,H]=s.useState(!1),[C,$]=s.useState(""),[S,W]=s.useState(""),[E,T]=s.useState(""),g=s.useRef(null),d=s.useRef(null),B=s.useRef(!1),y=s.useCallback(t=>{const a=b.defaults?.baseURL||"";return!!a&&a.replace(/\/+$/,"").endsWith("/api")?`/${t}`:`/api/${t}`},[]);s.useEffect(()=>{if(!u)return;B.current=!0,g.current=new AbortController;const t=g.current.signal,a=x?{Authorization:`Bearer ${x}`}:{},i=y("users"),h=y("users");(async function(){try{const[o,k]=await Promise.all([b.get(i,{params:{role:"client"},headers:a,signal:t}),b.get(h,{headers:a,signal:t})]),l=Array.isArray(j(o))?j(o):[];V(l),G(l);const U=j(k),se=Array.isArray(U)?U.filter(re=>String(re._id)!==String(A?._id)):[];Q(se)}catch(o){if(t&&t.aborted){console.log("NewCaseModal: fetch aborted");return}console.error("âŒ Error loading users:",o,o?.response?.data),m.error(o?.response?.data?.message||(o?.message?`Failed to load users: ${o.message}`:"Failed to load users"))}})();const c=document.body.style.overflow;return document.body.style.overflow="hidden",()=>{B.current=!1,g.current&&g.current.abort(),document.body.style.overflow=c||"auto"}},[u,x,A,y]);const f=t=>{const{name:a,value:i}=t.target;v(h=>({...h,[a]:i}))},Y=t=>{v(a=>({...a,sharedWith:a.sharedWith.includes(t)?a.sharedWith.filter(i=>i!==t):[...a.sharedWith,t]}))},Z=async t=>{const a=Array.from(t.target.files||[]);if(!a.length)return;if(R(!0),N(0),d.current)try{d.current.abort()}catch{}d.current=new AbortController;const i=d.current.signal,h=new FormData;a.forEach(r=>h.append("files",r));const c=y("upload/multiple");try{const r=await b.post(c,h,{headers:{"Content-Type":"multipart/form-data",...x?{Authorization:`Bearer ${x}`}:{}},onUploadProgress:l=>{const U=l.total?Math.round(l.loaded*100/l.total):0;N(U)},signal:i});let o=[];r?.data?.files?o=r.data.files:o=j(r)||[];const k=(Array.isArray(o)?o:[]).map(l=>({name:l.name||l.fileName||"file",fileUrl:l.fileUrl||l.url||l.path||l.fileUrl}));v(l=>({...l,attachments:[...l.attachments||[],...k]})),m.success(`${k.length} file(s) uploaded`)}catch(r){i&&i.aborted?m.error("Upload cancelled"):(console.error("âŒ Upload failed:",r,r?.response?.data),m.error(r?.response?.data?.message||r?.message||"Upload failed"))}finally{R(!1),N(0),d.current=null}},ee=()=>{if(d.current)try{d.current.abort(),d.current=null}catch(t){console.warn("Failed to cancel upload",t)}},te=()=>{if(!w)return{ok:!0};if(!C)return{ok:!1,message:"Please select a hearing date/time."};const t=new Date(C);return isNaN(t)?{ok:!1,message:"Hearing date is invalid."}:!S||!S.trim()?{ok:!1,message:"Please provide a hearing title."}:{ok:!0}},ae=async t=>{if(t.preventDefault(),!n.title||!n.title.trim()){m.error("Case title is required");return}if(!n.clientId){m.error("Please select a client");return}const a=te();if(!a.ok){m.error(a.message);return}_(!0);const i={...n,filedBy:A?._id};w&&(i.initialHearing={date:C,title:S,description:E||""});const h=y("cases");try{const c=await b.post(h,i,{headers:{...x?{Authorization:`Bearer ${x}`}:{}}}),r=c?.data?.data??c?.data??j(c);m.success("âœ… Case filed successfully"),q?.(r),M()}catch(c){console.error("âŒ Create case error:",c,c?.response?.data);const r=c?.response?.data?.message||c?.message||"Failed to create case";m.error(r)}finally{_(!1)}},M=()=>{if(v({title:"",description:"",clientId:"",respondentId:"",category:"civil",priority:"medium",attachments:[],sharedWith:[]}),N(0),F(!1),H(!1),$(""),W(""),T(""),d.current){try{d.current.abort()}catch{}d.current=null}if(g.current){try{g.current.abort()}catch{}g.current=null}p?.()};return e.jsx(ne,{children:u&&e.jsx(L.div,{className:"fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:e.jsxs(L.div,{className:"bg-white w-full max-w-md max-h-[90vh] overflow-y-auto rounded-2xl shadow-xl p-5 relative",initial:{y:50,opacity:0},animate:{y:0,opacity:1},exit:{y:50,opacity:0},children:[e.jsx("button",{"aria-label":"Close",className:"absolute top-3 right-3 text-gray-400 hover:text-gray-600",onClick:M,children:e.jsx(ce,{size:22})}),e.jsx("h2",{className:"text-lg font-semibold text-gray-800 mb-3",children:"ðŸ§¾ File New Case"}),e.jsxs("form",{onSubmit:ae,className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Case Title"}),e.jsx("input",{type:"text",name:"title",value:n.title,onChange:f,className:"w-full border border-gray-300 rounded-lg px-3 py-2 mt-1 text-sm focus:ring-2 focus:ring-blue-500",placeholder:"Enter case title",required:!0})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"text-sm font-medium text-gray-700 flex items-center gap-1",children:[e.jsx(de,{size:14})," Category"]}),e.jsxs("select",{name:"category",value:n.category,onChange:f,className:"w-full border border-gray-300 rounded-lg px-2 py-2 mt-1 text-sm",children:[e.jsx("option",{value:"civil",children:"Civil"}),e.jsx("option",{value:"criminal",children:"Criminal"}),e.jsx("option",{value:"adr",children:"ADR"}),e.jsx("option",{value:"other",children:"Other"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Priority"}),e.jsxs("select",{name:"priority",value:n.priority,onChange:f,className:"w-full border border-gray-300 rounded-lg px-2 py-2 mt-1 text-sm",children:[e.jsx("option",{value:"low",children:"Low"}),e.jsx("option",{value:"medium",children:"Medium"}),e.jsx("option",{value:"high",children:"High"}),e.jsx("option",{value:"urgent",children:"Urgent"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Client"}),e.jsxs("select",{name:"clientId",value:n.clientId,onChange:f,className:"w-full border border-gray-300 rounded-lg px-2 py-2 mt-1 text-sm",children:[e.jsx("option",{value:"",children:"Select client"}),O.map(t=>e.jsx("option",{value:t._id,children:t.name||t.email||t._id},t._id))]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"text-sm font-medium text-gray-700 flex items-center gap-1",children:["Respondent ",e.jsx(ie,{size:12,className:"text-gray-400",title:"Opposing party or defendant"})]}),e.jsxs("select",{name:"respondentId",value:n.respondentId,onChange:f,className:"w-full border border-gray-300 rounded-lg px-2 py-2 mt-1 text-sm",children:[e.jsx("option",{value:"",children:"Select respondent"}),X.map(t=>e.jsx("option",{value:t._id,children:t.name||t.email||t._id},t._id))]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Description"}),e.jsx("textarea",{name:"description",value:n.description,onChange:f,rows:3,className:"w-full border border-gray-300 rounded-lg px-3 py-2 mt-1 text-sm focus:ring-2 focus:ring-blue-500",placeholder:"Brief summary of the case"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Attachments"}),e.jsxs("label",{className:"flex items-center justify-center gap-2 border-2 border-dashed border-gray-300 rounded-lg py-3 cursor-pointer hover:border-blue-400 text-gray-500 mt-1 text-sm",children:[e.jsx(ue,{size:16}),D?`Uploading... ${I}%`:"Click or drop files",e.jsx("input",{type:"file",multiple:!0,onChange:Z,className:"hidden",disabled:D})]}),D&&I>0&&e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-blue-500 h-2 rounded-full transition-all duration-300",style:{width:`${I}%`}})}),e.jsx("button",{type:"button",onClick:ee,className:"text-sm text-red-600 ml-2",children:"Cancel"})]}),n.attachments?.length>0&&e.jsx("ul",{className:"text-sm text-gray-600 mt-1 space-y-1",children:n.attachments.map((t,a)=>e.jsx("li",{className:"truncate",children:e.jsx("a",{href:t.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:underline",children:t.name})},a))})]}),e.jsxs("div",{children:[e.jsxs("button",{type:"button",onClick:()=>F(t=>!t),className:"flex items-center gap-2 text-sm text-blue-600 mt-2",children:[e.jsx(oe,{size:15}),z?"Hide share list":"Share with others"]}),z&&e.jsx("div",{className:"max-h-32 overflow-y-auto border border-gray-200 rounded-lg mt-2",children:J.map(t=>e.jsxs("label",{className:"flex items-center justify-between px-3 py-2 hover:bg-gray-50 text-sm cursor-pointer border-b last:border-none",children:[e.jsx("span",{children:t.name||t.email}),e.jsx("input",{type:"checkbox",checked:n.sharedWith.includes(t._id),onChange:()=>Y(t._id),className:"accent-blue-600 w-4 h-4"})]},t._id))})]}),e.jsxs("div",{className:"pt-2 border-t",children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:w,onChange:()=>H(t=>!t),className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:"Schedule an initial hearing when filing (optional)"})]}),w&&e.jsxs("div",{className:"grid gap-2 mt-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Hearing Date & Time"}),e.jsx("input",{type:"datetime-local",value:C,onChange:t=>$(t.target.value),className:"w-full border border-gray-300 rounded-lg px-3 py-2 mt-1 text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Hearing Title"}),e.jsx("input",{type:"text",value:S,onChange:t=>W(t.target.value),placeholder:"e.g. Preliminary hearing",className:"w-full border border-gray-300 rounded-lg px-3 py-2 mt-1 text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Notes (optional)"}),e.jsx("textarea",{value:E,onChange:t=>T(t.target.value),rows:2,className:"w-full border border-gray-300 rounded-lg px-3 py-2 mt-1 text-sm",placeholder:"Details or meeting link"})]})]})]}),e.jsx("button",{type:"submit",disabled:P,className:"w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition text-sm disabled:opacity-50",children:P?"Submitting...":"File Case"})]})]})})})}export{ye as N};
