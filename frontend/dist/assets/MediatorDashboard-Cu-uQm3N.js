import{b as F,r as n,d,t as l,l as $,j as e,F as C,X as A,U as z}from"./index-DX-5XR_r.js";import{_ as I}from"./style-BVPaQRh9.js";import{u as P}from"./index.esm-BEqESI9Z.js";import{a as q,o as B,s as p,_ as V,n as J,b as K}from"./schemas-CQTzvhsC.js";import{P as H}from"./play-Cj5MgIbS.js";import{L as X}from"./link-BIoVTXN6.js";import{M as G}from"./message-square-nLpgcwjS.js";import{C as Q}from"./calendar-C1sSPIYC.js";const W="/socket.io",Y="http://localhost:5000",Z=B({title:p().min(3,"Title is required"),parties:K(p()).min(1,"Select at least one party"),scheduledAt:p().min(1,"Date and time required"),durationMinutes:J().min(10,"Duration must be at least 10 minutes"),mode:V(["virtual","in-person"]),locationOrUrl:p().optional().nullable(),notes:p().optional().nullable()});function ce(){const{user:j}=F()||{},[b,c]=n.useState([]),[N,M]=n.useState([]),[g,v]=n.useState(!0),[ee,w]=n.useState(null),[U,u]=n.useState(!1),[f,h]=n.useState(null),{register:x,handleSubmit:R,reset:y,watch:se,formState:{errors:o,isSubmitting:S},setValue:m}=P({resolver:q(Z),defaultValues:{title:"",parties:[],scheduledAt:"",durationMinutes:60,mode:"virtual",locationOrUrl:"",notes:""}}),k=n.useCallback(async()=>{v(!0);try{const[s,t]=await Promise.all([d.get("/sessions"),d.get("/parties").catch(()=>d.get("/clients").catch(()=>({data:[]})))]);c(Array.isArray(s.data)?s.data:[]),M(Array.isArray(t.data)?t.data:t.data||[])}catch(s){console.error("Failed to load mediator dashboard:",s),l.error(s?.response?.data?.message||"Failed to load data")}finally{v(!1)}},[]);n.useEffect(()=>{k()},[k]),n.useEffect(()=>{if(!j||!j._id)return;const s=$(Y,{path:W,transports:["websocket"],withCredentials:!0,auth:{token:localStorage.getItem("token")},query:{userId:j._id,role:j.role}});return w(s),s.on("connect",()=>{console.info("Mediator socket connected:",s.id),s.emit("join",{room:`mediator:${j._id}`})}),s.on("session:created",t=>{t&&(c(a=>[t,...a]),l.success(`New session scheduled: ${t.title}`))}),s.on("session:updated",t=>{t&&(c(a=>a.map(i=>i._id===t._id?t:i)),l.success(`Session updated: ${t.title}`))}),s.on("session:cancelled",({id:t,reason:a})=>{c(i=>i.filter(r=>r._id!==t)),l.success("Session cancelled")}),s.on("notifications:new",t=>{l.info(t?.message||"New notification")}),s.on("disconnect",t=>{console.warn("Socket disconnected:",t)}),s.on("connect_error",t=>{console.error("Socket connect error:",t),l.error("Realtime connection error")}),()=>{s.removeAllListeners(),s.disconnect(),w(null)}},[j]);const D=async s=>{try{const t={...s,durationMinutes:Number(s.durationMinutes)};if(f){const{data:a}=await d.put(`/sessions/${f._id}`,t);c(i=>i.map(r=>r._id===a._id?a:r)),l.success("Session updated")}else{const{data:a}=await d.post("/sessions",t);c(i=>[a,...i]),l.success("Session created")}y(),h(null),u(!1)}catch(t){throw console.error("Failed to save session:",t),l.error(t?.response?.data?.message||"Failed to save session"),t}},O=s=>{h(s),u(!0),m("title",s.title||""),m("parties",s.parties?.map(t=>t._id?t._id:t)||[]),m("scheduledAt",new Date(s.scheduledAt).toISOString().slice(0,16)),m("durationMinutes",s.durationMinutes||60),m("mode",s.mode||"virtual"),m("locationOrUrl",s.locationOrUrl||""),m("notes",s.notes||"")},E=async s=>{if(confirm("Are you sure you want to cancel this session?"))try{await d.delete(`/sessions/${s}`),c(t=>t.filter(a=>a._id!==s)),l.success("Session cancelled")}catch(t){console.error("Cancel failed:",t),l.error("Failed to cancel session")}},L=s=>{if(s.mode==="virtual"){const t=s.locationOrUrl||s.virtualRoomUrl;if(!t){l.error("No virtual room link available");return}window.open(t,"_blank")}else s.locationOrUrl?window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(s.locationOrUrl)}`,"_blank"):l("In-person location not provided")},T=async s=>{try{const t=await d.get(`/reports/sessions/${s}`,{responseType:"blob"}),a=window.URL.createObjectURL(new Blob([t.data])),i=document.createElement("a");i.href=a,i.setAttribute("download",`session-${s}-report.pdf`),document.body.appendChild(i),i.click(),i.remove(),l.success("Report downloaded")}catch(t){console.error("Report error:",t),l.error("Failed to download report")}},_=n.useMemo(()=>{const s={};for(const a of b){const i=new Date(a.scheduledAt);if(Number.isNaN(i.getTime()))continue;const r=i.toLocaleDateString();s[r]=s[r]||[],s[r].push(a)}const t=Object.keys(s).sort((a,i)=>new Date(a)-new Date(i));return{groups:s,orderedKeys:t}},[b]);return e.jsxs("div",{className:"jsx-1325885819 mediator-dashboard min-h-screen p-6 bg-black-50",children:[e.jsxs("div",{className:"jsx-1325885819 flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6",children:[e.jsxs("div",{className:"jsx-1325885819",children:[e.jsx("h1",{className:"jsx-1325885819 text-3xl font-extrabold text-slate-900",children:"Mediator Dashboard"}),e.jsx("p",{className:"jsx-1325885819 text-slate-600 mt-1",children:"Manage mediation sessions, parties and outcomes in real time."})]}),e.jsxs("div",{className:"jsx-1325885819 flex gap-3",children:[e.jsxs("button",{onClick:()=>{h(null),y(),u(!0)},className:"jsx-1325885819 inline-flex items-center gap-2 px-4 py-2 rounded-md bg-blue-600 text-white",children:[e.jsx(H,{size:16})," New Session"]}),e.jsxs("button",{onClick:()=>{(async()=>{try{const s=await d.get("/reports/sessions",{responseType:"blob"}),t=window.URL.createObjectURL(new Blob([s.data])),a=document.createElement("a");a.href=t,a.setAttribute("download","mediator_sessions_report.pdf"),document.body.appendChild(a),a.click(),a.remove(),l.success("Report downloaded")}catch(s){console.error("Failed to download sessions report",s),l.error("Failed to download report")}})()},className:"jsx-1325885819 inline-flex items-center gap-2 px-4 py-2 rounded-md bg-black-700 text-white",children:[e.jsx(C,{size:16})," Export Reports"]})]})]}),e.jsxs("div",{className:"jsx-1325885819 grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("section",{className:"jsx-1325885819 lg:col-span-2 space-y-4",children:[e.jsxs("div",{className:"jsx-1325885819 bg-white p-4 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"jsx-1325885819 flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"jsx-1325885819 text-lg font-semibold",children:"Upcoming Sessions"}),e.jsxs("div",{className:"jsx-1325885819 text-sm text-slate-500",children:[b.length," total"]})]}),g?e.jsxs("div",{className:"jsx-1325885819 space-y-3 animate-pulse",children:[e.jsx("div",{className:"jsx-1325885819 h-6 bg-black-200 rounded"}),e.jsx("div",{className:"jsx-1325885819 h-6 bg-black-200 rounded"})]}):b.length===0?e.jsx("div",{className:"jsx-1325885819 text-slate-500",children:"No sessions scheduled."}):_.orderedKeys.map(s=>e.jsxs("div",{className:"jsx-1325885819 mb-4",children:[e.jsx("div",{className:"jsx-1325885819 text-sm font-medium text-slate-700 mb-2",children:s}),e.jsx("div",{className:"jsx-1325885819 space-y-2",children:_.groups[s].sort((t,a)=>new Date(t.scheduledAt)-new Date(a.scheduledAt)).map(t=>e.jsxs("div",{className:"jsx-1325885819 p-3 rounded-md bg-slate-50 flex items-start justify-between",children:[e.jsxs("div",{className:"jsx-1325885819",children:[e.jsx("div",{className:"jsx-1325885819 font-semibold",children:t.title}),e.jsxs("div",{className:"jsx-1325885819 text-xs text-slate-500",children:[new Date(t.scheduledAt).toLocaleTimeString()," • ",t.durationMinutes," mins • ",t.mode]}),e.jsx("div",{className:"jsx-1325885819 text-xs text-slate-500 mt-1",children:(t.parties||[]).map(a=>a.name||a).join(", ")})]}),e.jsxs("div",{className:"jsx-1325885819 flex flex-col items-end gap-2",children:[e.jsxs("div",{className:"jsx-1325885819 flex gap-2",children:[e.jsxs("button",{onClick:()=>L(t),className:"jsx-1325885819 px-3 py-1 rounded bg-blue-600 text-white text-xs flex items-center gap-1",children:[e.jsx(X,{size:12})," Join"]}),e.jsx("button",{onClick:()=>O(t),className:"jsx-1325885819 px-3 py-1 rounded bg-white border text-xs",children:"Edit"})]}),e.jsxs("div",{className:"jsx-1325885819 flex gap-2 items-center",children:[e.jsx("button",{onClick:()=>T(t._id),title:"Download session report",className:"jsx-1325885819 text-xs text-slate-600 hover:text-slate-800",children:e.jsx(C,{size:14})}),e.jsx("button",{onClick:()=>E(t._id),title:"Cancel session",className:"jsx-1325885819 text-xs text-red-600 hover:text-red-800",children:e.jsx(A,{size:14})})]})]})]},t._id))})]},s))]}),e.jsxs("div",{className:"jsx-1325885819 bg-white p-4 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"jsx-1325885819 flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"jsx-1325885819 text-lg font-semibold",children:"Session Notes / Outcomes"}),e.jsx("div",{className:"jsx-1325885819 text-sm text-slate-500",children:"Record final outcomes"})]}),e.jsxs("div",{className:"jsx-1325885819 text-slate-600",children:[e.jsx("p",{className:"jsx-1325885819 mb-2",children:"Select a session to add notes or mark outcome. Session notes are saved to the session record and synced to all participants in real time."}),e.jsx("p",{className:"jsx-1325885819 text-sm text-slate-500",children:"Open any session and use the Edit button to add notes or outcome."})]})]})]}),e.jsxs("aside",{className:"jsx-1325885819 space-y-4",children:[e.jsxs("div",{className:"jsx-1325885819 bg-white p-4 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"jsx-1325885819 flex items-center justify-between mb-3",children:[e.jsxs("h3",{className:"jsx-1325885819 font-semibold flex items-center gap-2",children:[e.jsx(z,{})," Parties"]}),e.jsx("div",{className:"jsx-1325885819 text-sm text-slate-500",children:N.length})]}),e.jsx("div",{className:"jsx-1325885819",children:g?e.jsxs("div",{className:"jsx-1325885819 space-y-2 animate-pulse",children:[e.jsx("div",{className:"jsx-1325885819 h-8 bg-black-200 rounded"}),e.jsx("div",{className:"jsx-1325885819 h-8 bg-black-200 rounded"})]}):N.length===0?e.jsx("div",{className:"jsx-1325885819 text-slate-500",children:"No parties found"}):e.jsx("ul",{className:"jsx-1325885819 max-h-64 overflow-auto space-y-2",children:N.map(s=>e.jsxs("li",{className:"jsx-1325885819 flex items-center justify-between p-2 rounded hover:bg-slate-50",children:[e.jsxs("div",{className:"jsx-1325885819",children:[e.jsx("div",{className:"jsx-1325885819 font-medium",children:s.name||s.fullName||s.title||s.email}),e.jsx("div",{className:"jsx-1325885819 text-xs text-slate-500",children:s.email||s.phone||""})]}),e.jsx("div",{className:"jsx-1325885819 flex gap-2",children:e.jsx("button",{onClick:()=>{window.open(`/messages/compose?to=${encodeURIComponent(s._id||s.email)}`,"_blank")},title:"Message",className:"jsx-1325885819 text-slate-600",children:e.jsx(G,{size:16})})})]},s._id||s.email||s.id))})})]}),e.jsxs("div",{className:"jsx-1325885819 bg-white p-4 rounded-lg shadow-sm",children:[e.jsxs("div",{className:"jsx-1325885819 flex items-center justify-between mb-3",children:[e.jsxs("h3",{className:"jsx-1325885819 font-semibold flex items-center gap-2",children:[e.jsx(Q,{})," Today"]}),e.jsx("div",{className:"jsx-1325885819 text-sm text-slate-500",children:new Date().toLocaleDateString()})]}),e.jsx("div",{className:"jsx-1325885819 text-sm text-slate-600",children:e.jsx("p",{className:"jsx-1325885819 mb-2",children:"Today's sessions are highlighted in the main list. Click Join to start or view details."})})]})]})]}),U&&e.jsx("div",{className:"jsx-1325885819 fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4",children:e.jsxs("div",{className:"jsx-1325885819 bg-white rounded-lg shadow-lg w-full max-w-2xl p-6",children:[e.jsxs("div",{className:"jsx-1325885819 flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"jsx-1325885819 text-lg font-semibold",children:f?"Edit Session":"New Session"}),e.jsx("div",{className:"jsx-1325885819 flex items-center gap-2",children:e.jsx("button",{onClick:()=>{u(!1),h(null)},className:"jsx-1325885819 p-2 rounded hover:bg-slate-100",children:e.jsx(A,{})})})]}),e.jsxs("form",{onSubmit:R(D),className:"jsx-1325885819 space-y-4",children:[e.jsxs("div",{className:"jsx-1325885819",children:[e.jsx("label",{className:"jsx-1325885819 block text-sm font-medium",children:"Title"}),e.jsx("input",{...x("title"),className:"jsx-1325885819 mt-1 w-full rounded-md border p-2"}),o.title&&e.jsx("p",{className:"jsx-1325885819 text-xs text-red-600",children:o.title.message})]}),e.jsxs("div",{className:"jsx-1325885819",children:[e.jsx("label",{className:"jsx-1325885819 block text-sm font-medium",children:"Parties"}),e.jsx("select",{...x("parties"),multiple:!0,size:4,className:"jsx-1325885819 mt-1 w-full rounded-md border p-2",children:N.map(s=>e.jsx("option",{value:s._id||s.email,className:"jsx-1325885819",children:s.name||s.email},s._id||s.email))}),o.parties&&e.jsx("p",{className:"jsx-1325885819 text-xs text-red-600",children:o.parties.message})]}),e.jsxs("div",{className:"jsx-1325885819 grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{className:"jsx-1325885819",children:[e.jsx("label",{className:"jsx-1325885819 block text-sm font-medium",children:"Date & Time"}),e.jsx("input",{...x("scheduledAt"),type:"datetime-local",className:"jsx-1325885819 mt-1 w-full rounded-md border p-2"}),o.scheduledAt&&e.jsx("p",{className:"jsx-1325885819 text-xs text-red-600",children:o.scheduledAt.message})]}),e.jsxs("div",{className:"jsx-1325885819",children:[e.jsx("label",{className:"jsx-1325885819 block text-sm font-medium",children:"Duration (minutes)"}),e.jsx("input",{...x("durationMinutes",{valueAsNumber:!0}),type:"number",min:10,className:"jsx-1325885819 mt-1 w-full rounded-md border p-2"}),o.durationMinutes&&e.jsx("p",{className:"jsx-1325885819 text-xs text-red-600",children:o.durationMinutes.message})]})]}),e.jsxs("div",{className:"jsx-1325885819 grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{className:"jsx-1325885819",children:[e.jsx("label",{className:"jsx-1325885819 block text-sm font-medium",children:"Mode"}),e.jsxs("select",{...x("mode"),className:"jsx-1325885819 mt-1 w-full rounded-md border p-2",children:[e.jsx("option",{value:"virtual",className:"jsx-1325885819",children:"Virtual (video link)"}),e.jsx("option",{value:"in-person",className:"jsx-1325885819",children:"In-person"})]})]}),e.jsxs("div",{className:"jsx-1325885819",children:[e.jsx("label",{className:"jsx-1325885819 block text-sm font-medium",children:"Location / Video URL"}),e.jsx("input",{...x("locationOrUrl"),className:"jsx-1325885819 mt-1 w-full rounded-md border p-2"})]})]}),e.jsxs("div",{className:"jsx-1325885819",children:[e.jsx("label",{className:"jsx-1325885819 block text-sm font-medium",children:"Notes (optional)"}),e.jsx("textarea",{...x("notes"),rows:3,className:"jsx-1325885819 mt-1 w-full rounded-md border p-2"})]}),e.jsxs("div",{className:"jsx-1325885819 flex justify-end gap-3",children:[e.jsx("button",{type:"button",onClick:()=>{u(!1),h(null)},className:"jsx-1325885819 px-4 py-2 rounded-md bg-black-100",children:"Cancel"}),e.jsx("button",{disabled:S,type:"submit",className:"jsx-1325885819 px-4 py-2 rounded-md bg-blue-600 text-white",children:S?"Saving...":f?"Save changes":"Create session"})]})]})]})}),e.jsx(I,{id:"1325885819",children:['.mediator-dashboard.jsx-1325885819{font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}']})]})}export{ce as default};
